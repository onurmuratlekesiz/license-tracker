<!DOCTYPE html>
<html lang="tr" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'; connect-src https://*.googleapis.com https://*.firebaseio.com https://*.cloudfunctions.net wss://*.firebaseio.com;">
<title>LisansTakip â€” Envanter Sistemi</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Bricolage+Grotesque:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

const firebaseConfig = {
  apiKey: "AIzaSyBGDd-BPvTAbFculUUWCd8Gtgh03cYwzAg",
  authDomain: "license-tracker-fb51b.firebaseapp.com",
  projectId: "license-tracker-fb51b",
  storageBucket: "license-tracker-fb51b.firebasestorage.app",
  messagingSenderId: "284167863677",
  appId: "1:284167863677:web:016c4633561354317c2014"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);

// Auth state persistence â€” auto-restore session
onAuthStateChanged(auth, user => {
  if (user) {
    window._fbUser = user;
    const chip = document.getElementById('userChip');
    if (chip) chip.textContent = user.email;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').style.display   = 'block';
    if (window._appReady) window._appReady();
  }
});

window._fb = { db, auth, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, serverTimestamp, signInWithEmailAndPassword, signOut };
window.dispatchEvent(new Event('firebaseReady'));
</script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
[data-theme="light"] {
  --bg:         #f2f0ec;
  --bg2:        #e8e5df;
  --surface:    #ffffff;
  --surface2:   #f8f6f2;
  --border:     #dedad2;
  --text:       #18160f;
  --text2:      #56524a;
  --muted:      #9a9690;
  --accent:     #c84b08;
  --accent-bg:  #fef0e8;
  --accent-h:   #a83d06;
  --blue:       #1760a8;
  --blue-bg:    #e8f0fb;
  --ok:         #187040;
  --ok-bg:      #e6f5ee;
  --warn:       #a86000;
  --warn-bg:    #fef5e0;
  --danger:     #b82828;
  --danger-bg:  #fdeaea;
  --shadow:     0 2px 8px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.05);
  --shadow-sm:  0 1px 3px rgba(0,0,0,0.07);
}
[data-theme="dark"] {
  --bg:         #111008;
  --bg2:        #1a1910;
  --surface:    #201e14;
  --surface2:   #28261a;
  --border:     #38361e;
  --text:       #f0ede0;
  --text2:      #a09a88;
  --muted:      #686050;
  --accent:     #e86020;
  --accent-bg:  #2c1a08;
  --accent-h:   #f07030;
  --blue:       #50a0f0;
  --blue-bg:    #0a1e38;
  --ok:         #30c060;
  --ok-bg:      #081a10;
  --warn:       #e09020;
  --warn-bg:    #1e1400;
  --danger:     #e04040;
  --danger-bg:  #200808;
  --shadow:     0 2px 8px rgba(0,0,0,0.4), 0 8px 24px rgba(0,0,0,0.3);
  --shadow-sm:  0 1px 3px rgba(0,0,0,0.3);
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Bricolage Grotesque', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.5;
  transition: background .3s, color .3s;
}

/* â•â• THEME TOGGLE â•â• */
.toggle-wrap { display:flex; align-items:center; gap:.4rem; }
.theme-icon  { font-size:.8rem; user-select:none; }
.theme-toggle {
  width:40px; height:22px;
  background: var(--border);
  border-radius:11px; border:none; cursor:pointer;
  position:relative; transition:background .3s; flex-shrink:0;
}
.theme-toggle::after {
  content:''; position:absolute;
  top:3px; left:3px;
  width:16px; height:16px; border-radius:50%;
  background:var(--surface); transition:transform .3s;
  box-shadow: var(--shadow-sm);
}
[data-theme="dark"] .theme-toggle           { background:var(--accent); }
[data-theme="dark"] .theme-toggle::after    { transform:translateX(18px); }

/* â•â• INPUTS â•â• */
label {
  display:block; font-size:.7rem; font-weight:600;
  color:var(--text2); margin-bottom:.3rem; letter-spacing:.01em;
}
.input-wrap { position:relative; }
.input-prefix, .input-suffix {
  position:absolute; top:50%; transform:translateY(-50%);
  font-size:.82rem; color:var(--muted); pointer-events:none;
  font-family:'DM Mono',monospace;
}
.input-prefix { left:.75rem; }
.input-suffix { right:.75rem; }
.has-prefix input  { padding-left:1.8rem !important; }
.has-suffix input  { padding-right:2.4rem !important; }

input, select, textarea {
  width:100%;
  background:var(--bg2); border:1.5px solid var(--border);
  color:var(--text); padding:.65rem .85rem;
  font-family:'Bricolage Grotesque',sans-serif; font-size:.88rem;
  border-radius:8px; outline:none;
  transition:border-color .2s, box-shadow .2s, background .2s;
  /* Force date input to fit */
  min-width:0;
}
input:focus, select:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-bg); background:var(--surface); }
input::placeholder, textarea::placeholder { color:var(--muted); }

/* Date picker fix â€” ensure calendar opens on click */
input[type="date"] {
  cursor:pointer;
  appearance:auto;
  -webkit-appearance:auto;
}
input[type="date"]::-webkit-calendar-picker-indicator {
  cursor:pointer;
  opacity:.6;
  filter: var(--date-icon-filter, none);
}
[data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator {
  filter:invert(1);
}

.form-group  { margin-bottom:.85rem; }
.form-row    { display:grid; grid-template-columns:1fr 1fr; gap:.65rem; }
.form-row-3  { display:grid; grid-template-columns:1fr 1fr 1fr; gap:.65rem; }

/* â•â• BUTTONS â•â• */
.btn {
  display:inline-flex; align-items:center; justify-content:center; gap:.4rem;
  padding:.6rem 1.1rem; border-radius:8px; font-family:inherit;
  font-size:.83rem; font-weight:700; cursor:pointer;
  border:1.5px solid transparent; transition:all .15s;
}
.btn-accent  { background:var(--accent);  color:#fff; border-color:var(--accent); }
.btn-accent:hover  { background:var(--accent-h); border-color:var(--accent-h); }
.btn-accent:disabled { opacity:.55; cursor:not-allowed; }
.btn-ghost   { background:transparent; border-color:var(--border); color:var(--text2); }
.btn-ghost:hover   { border-color:var(--accent); color:var(--accent); }
.btn-danger  { background:transparent; border-color:var(--danger); color:var(--danger); }
.btn-danger:hover  { background:var(--danger); color:#fff; }
.btn-full    { width:100%; padding:.72rem; font-size:.9rem; }
.btn-sm      { padding:.32rem .8rem; font-size:.76rem; border-radius:6px; }

/* â•â• LOGIN â•â• */
#loginScreen {
  min-height:100vh; display:flex; align-items:center; justify-content:center;
  padding:2rem; background:var(--bg);
}
.login-wrap {
  display:grid; grid-template-columns:1fr 1fr;
  max-width:880px; width:100%; border-radius:18px;
  overflow:hidden; box-shadow:var(--shadow); border:1px solid var(--border);
}
.login-left {
  background:var(--accent); padding:3rem;
  display:flex; flex-direction:column; justify-content:space-between;
  position:relative; overflow:hidden;
}
.login-left::before {
  content:''; position:absolute; top:-50px; right:-50px;
  width:180px; height:180px; border-radius:50%; background:rgba(255,255,255,.13);
}
.login-left::after {
  content:''; position:absolute; bottom:-40px; left:-30px;
  width:140px; height:140px; border-radius:50%; background:rgba(255,255,255,.08);
}
.ll-brand h1  { font-size:2.2rem; font-weight:800; color:#fff; line-height:1.05; margin-bottom:.5rem; }
.ll-brand p   { color:rgba(255,255,255,.78); font-size:.88rem; line-height:1.5; }
.ll-feats     { display:flex; flex-direction:column; gap:.65rem; position:relative; z-index:1; }
.ll-feat      { display:flex; align-items:center; gap:.65rem; color:rgba(255,255,255,.9); font-size:.82rem; }
.ll-dot       { width:6px; height:6px; border-radius:50%; background:rgba(255,255,255,.65); flex-shrink:0; }

.login-right  { background:var(--surface); padding:3rem; display:flex; flex-direction:column; justify-content:center; }
.lr-head      { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:2rem; }
.lr-title     { font-size:1.35rem; font-weight:800; }
.lr-sub       { font-size:.72rem; color:var(--muted); font-family:'DM Mono',monospace; margin-top:.2rem; }
.fb-chip {
  display:inline-flex; align-items:center; gap:.4rem;
  padding:.28rem .7rem; background:var(--accent-bg);
  border:1px solid var(--accent); border-radius:99px;
  font-family:'DM Mono',monospace; font-size:.6rem; color:var(--accent);
  margin-bottom:1.5rem;
}
.login-btn    { width:100%; padding:.8rem; background:var(--accent); color:#fff; border:none; border-radius:8px; font-family:inherit; font-size:.95rem; font-weight:700; cursor:pointer; margin-top:.4rem; transition:opacity .2s, transform .2s; }
.login-btn:hover { opacity:.9; transform:translateY(-1px); }
.login-btn:disabled { opacity:.6; transform:none; cursor:not-allowed; }
.err-msg { color:var(--danger); font-family:'DM Mono',monospace; font-size:.7rem; margin-top:.75rem; padding:.65rem .9rem; background:var(--danger-bg); border:1px solid var(--danger); border-radius:6px; display:none; }

/* â•â• APP HEADER â•â• */
#appScreen { display:none; }
.header {
  display:flex; align-items:center; justify-content:space-between;
  padding:0 1.5rem; height:56px;
  background:var(--surface); border-bottom:1px solid var(--border);
  position:sticky; top:0; z-index:200; box-shadow:var(--shadow-sm);
}
.header-brand  { font-size:1.05rem; font-weight:800; letter-spacing:-.02em; }
.header-brand span { color:var(--accent); }
.header-right  { display:flex; align-items:center; gap:.65rem; }
.user-chip {
  font-family:'DM Mono',monospace; font-size:.62rem; color:var(--muted);
  padding:.28rem .7rem; background:var(--surface2); border:1px solid var(--border); border-radius:99px;
  max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}

/* â•â• STATS â•â• */
.stats-bar {
  display:grid; grid-template-columns:repeat(4,1fr);
  gap:1rem; padding:1rem 1.5rem;
  background:var(--bg2); border-bottom:1px solid var(--border);
}
.stat-card {
  background:var(--surface); border:1px solid var(--border); border-radius:12px;
  padding:.9rem 1.1rem; display:flex; align-items:center; gap:.9rem;
  box-shadow:var(--shadow-sm); transition:transform .15s;
}
.stat-card:hover { transform:translateY(-1px); }
.stat-ico { width:38px; height:38px; border-radius:9px; display:flex; align-items:center; justify-content:center; font-size:1rem; flex-shrink:0; }
.stat-ico.n { background:var(--bg2); }
.stat-ico.ok { background:var(--ok-bg); }
.stat-ico.wa { background:var(--warn-bg); }
.stat-ico.da { background:var(--danger-bg); }
.stat-lbl { font-size:.66rem; color:var(--muted); font-weight:500; }
.stat-val { font-size:1.6rem; font-weight:800; letter-spacing:-.03em; line-height:1.1; }
.stat-val.ok { color:var(--ok); } .stat-val.wa { color:var(--warn); } .stat-val.da { color:var(--danger); } .stat-val.n { color:var(--text); }

/* â•â• ALERT BANNER â•â• */
.alert-banner {
  margin:1rem 1.5rem 0; padding:.85rem 1.1rem;
  border:1px solid var(--warn); background:var(--warn-bg); border-radius:10px;
  display:none; align-items:flex-start; gap:.75rem;
}
.alert-banner.show { display:flex; }
.ab-icon  { font-size:1rem; flex-shrink:0; margin-top:2px; }
.ab-title { font-weight:700; font-size:.8rem; color:var(--warn); margin-bottom:.25rem; }
.ab-list  { font-family:'DM Mono',monospace; font-size:.63rem; color:var(--text2); list-style:none; }
.ab-list li { padding:.08rem 0; }
.ab-list li::before { content:'â€º '; color:var(--warn); }

/* â•â• MAIN LAYOUT â•â• */
.main { display:grid; grid-template-columns:290px 1fr; min-height:calc(100vh - 56px); }

/* â•â• SIDEBAR â•â• */
.sidebar {
  background:var(--surface); border-right:1px solid var(--border);
  overflow-y:auto; height:calc(100vh - 56px); position:sticky; top:56px;
}

/* Accordion sections */
.acc-section { border-bottom:1px solid var(--border); }
.acc-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:.85rem 1.25rem; cursor:pointer;
  user-select:none; transition:background .15s;
}
.acc-header:hover { background:var(--surface2); }
.acc-header-left { display:flex; align-items:center; gap:.55rem; }
.acc-header-icon { font-size:.9rem; }
.acc-header-title { font-size:.78rem; font-weight:700; color:var(--text); }
.acc-header-sub   { font-size:.65rem; color:var(--muted); font-family:'DM Mono',monospace; }
.acc-chevron {
  font-size:.7rem; color:var(--muted); transition:transform .25s;
  flex-shrink:0;
}
.acc-section.open .acc-chevron { transform:rotate(180deg); }
.acc-body {
  overflow:hidden; max-height:0;
  transition:max-height .3s ease, opacity .2s;
  opacity:0; padding:0 1.25rem;
}
.acc-section.open .acc-body { max-height:1200px; opacity:1; padding:1rem 1.25rem 1.25rem; }

.sidebar-save-wrap { padding:1rem 1.25rem; }

/* â•â• CONTENT â•â• */
.content-area { padding:1.25rem 1.5rem; background:var(--bg); }

.toolbar {
  display:flex; align-items:center; gap:.65rem;
  margin-bottom:1.1rem; flex-wrap:wrap;
}
.search-wrap { flex:1; min-width:180px; max-width:300px; position:relative; }
.search-wrap input { padding-left:2.1rem; font-size:.83rem; }
.search-ico { position:absolute; left:.7rem; top:50%; transform:translateY(-50%); color:var(--muted); font-size:.8rem; pointer-events:none; }

.filter-pills { display:flex; gap:.3rem; flex-wrap:wrap; }
.filter-pill {
  padding:.3rem .8rem; border-radius:99px; font-size:.72rem; font-weight:600;
  cursor:pointer; border:1.5px solid var(--border); background:transparent; color:var(--text2);
  transition:all .15s; font-family:inherit;
}
.filter-pill:hover  { border-color:var(--accent); color:var(--accent); }
.filter-pill.active { background:var(--accent); border-color:var(--accent); color:#fff; }

.toolbar-right { margin-left:auto; display:flex; align-items:center; gap:.5rem; }
.loading-wrap  { display:none; align-items:center; gap:.4rem; font-family:'DM Mono',monospace; font-size:.68rem; color:var(--muted); }
.spinner { width:13px; height:13px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .6s linear infinite; flex-shrink:0; }

/* Cost summary row */
.cost-summary {
  display:flex; align-items:center; gap:.4rem;
  font-family:'DM Mono',monospace; font-size:.7rem; color:var(--text2);
  padding:.5rem .9rem; background:var(--surface2); border:1px solid var(--border);
  border-radius:8px; white-space:nowrap;
}
.cost-summary strong { color:var(--accent); }

/* â•â• TABLE â•â• */
.table-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:12px; overflow:hidden; box-shadow:var(--shadow-sm);
}
table { width:100%; border-collapse:collapse; }
thead th {
  padding:.65rem .9rem; text-align:left;
  font-size:.63rem; font-weight:700; color:var(--muted);
  letter-spacing:.07em; text-transform:uppercase;
  background:var(--surface2); border-bottom:1px solid var(--border); white-space:nowrap;
}
tbody tr { border-bottom:1px solid var(--border); transition:background .12s; }
tbody tr:last-child { border-bottom:none; }
tbody tr:hover { background:var(--surface2); }
tbody td { padding:.8rem .9rem; font-size:.84rem; vertical-align:middle; }

/* â•â• BADGES â•â• */
.badge {
  display:inline-flex; align-items:center; gap:.25rem;
  padding:.18rem .55rem; border-radius:99px;
  font-size:.65rem; font-weight:700; border:1px solid transparent;
  white-space:nowrap;
}
.b-ok  { color:var(--ok);   background:var(--ok-bg);     border-color:var(--ok);   }
.b-wa  { color:var(--warn); background:var(--warn-bg);   border-color:var(--warn); }
.b-da  { color:var(--danger);background:var(--danger-bg);border-color:var(--danger);}
.b-bl  { color:var(--blue); background:var(--blue-bg);   border-color:var(--blue); }

.days-chip {
  display:inline-block; font-family:'DM Mono',monospace;
  font-size:.72rem; font-weight:500; padding:.14rem .48rem; border-radius:4px;
}
.days-chip.ok { color:var(--ok);    background:var(--ok-bg);   }
.days-chip.wa { color:var(--warn);  background:var(--warn-bg); }
.days-chip.da { color:var(--danger);background:var(--danger-bg);}

.soft    { color:var(--text2); }
.mono-sm { font-family:'DM Mono',monospace; font-size:.63rem; color:var(--muted); margin-top:2px; }

.act-btn {
  width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center;
  border:1px solid var(--border); background:transparent; color:var(--muted);
  border-radius:6px; cursor:pointer; font-size:.76rem; transition:all .14s;
}
.act-btn:hover       { border-color:var(--accent);  color:var(--accent);  background:var(--accent-bg); }
.act-btn.del:hover   { border-color:var(--danger);  color:var(--danger);  background:var(--danger-bg);}
.act-btn.view:hover  { border-color:var(--blue);    color:var(--blue);    background:var(--blue-bg);  }
.actions { display:flex; gap:.35rem; }

.empty-state { text-align:center; padding:4rem 2rem; color:var(--muted); }
.empty-ico   { font-size:2.5rem; margin-bottom:.7rem; }
.empty-title { font-size:.95rem; font-weight:700; color:var(--text2); margin-bottom:.3rem; }
.empty-sub   { font-family:'DM Mono',monospace; font-size:.68rem; }

/* â•â• MODAL â•â• */
.modal-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  backdrop-filter:blur(3px); z-index:500;
  display:none; align-items:center; justify-content:center; padding:1rem;
}
.modal-overlay.open { display:flex; }
.modal {
  background:var(--surface); border:1px solid var(--border);
  border-radius:16px; width:100%; max-width:520px;
  padding:2rem; box-shadow:var(--shadow); max-height:90vh; overflow-y:auto;
}
.modal-title { font-size:1.05rem; font-weight:800; margin-bottom:1.35rem; display:flex; align-items:center; gap:.5rem; }
.modal-grid  { display:grid; grid-template-columns:1fr 1fr; gap:.7rem; }
.modal-grid .full { grid-column:1/-1; }
.modal-actions { display:flex; gap:.65rem; margin-top:1.35rem; justify-content:flex-end; }

/* Detail modal */
.detail-row   { display:flex; justify-content:space-between; align-items:center; padding:.55rem 0; border-bottom:1px solid var(--border); font-size:.85rem; }
.detail-row:last-child { border-bottom:none; }
.detail-key   { font-size:.68rem; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:.06em; }
.detail-val   { font-weight:500; text-align:right; max-width:60%; word-break:break-all; }

/* Security notice */
.sec-notice {
  margin:0 1.5rem 1rem; padding:.7rem 1rem;
  background:var(--blue-bg); border:1px solid var(--blue); border-radius:8px;
  font-size:.72rem; color:var(--blue); display:none; align-items:flex-start; gap:.5rem;
}
.sec-notice.show { display:flex; }

/* Progress bar for license life */
.progress-wrap { width:80px; height:5px; background:var(--bg2); border-radius:3px; overflow:hidden; }
.progress-bar  { height:100%; border-radius:3px; transition:width .4s; }

@keyframes spin { to { transform:rotate(360deg); } }
@keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
tbody tr { animation:slideIn .2s ease; }

/* â•â• RESPONSIVE â•â• */
@media (max-width:900px) {
  .login-wrap { grid-template-columns:1fr; }
  .login-left { display:none; }
  .main { grid-template-columns:1fr; }
  .sidebar { height:auto; position:static; border-right:none; border-bottom:1px solid var(--border); }
  .stats-bar { grid-template-columns:1fr 1fr; }
}
@media (max-width:600px) {
  .stats-bar { grid-template-columns:1fr 1fr; padding:.75rem; gap:.6rem; }
  .content-area { padding:1rem; }
  .header { padding:0 1rem; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â• -->
<div id="loginScreen">
  <div class="login-wrap">
    <div class="login-left">
      <div class="ll-brand">
        <h1>Lisans<br>Takip</h1>
        <p>YazÄ±lÄ±m lisanslarÄ±nÄ±zÄ± tek yerden yÃ¶netin, bitiÅŸ tarihlerini asla kaÃ§Ä±rmayÄ±n.</p>
      </div>
      <div class="ll-feats">
        <div class="ll-feat"><div class="ll-dot"></div>Firebase Firestore gerÃ§ek zamanlÄ± veri</div>
        <div class="ll-feat"><div class="ll-dot"></div>BitiÅŸ tarihi uyarÄ± sistemi</div>
        <div class="ll-feat"><div class="ll-dot"></div>Toplam maliyet analizi</div>
        <div class="ll-feat"><div class="ll-dot"></div>CSV export & detay gÃ¶rÃ¼nÃ¼mÃ¼</div>
      </div>
    </div>
    <div class="login-right">
      <div class="lr-head">
        <div>
          <div class="lr-title">GiriÅŸ Yap</div>
          <div class="lr-sub">license-tracker-fb51b</div>
        </div>
        <div class="toggle-wrap">
          <span class="theme-icon" id="themeIcon">â˜€ï¸</span>
          <button class="theme-toggle" id="themeToggle"></button>
        </div>
      </div>
      <div class="fb-chip">ğŸ”¥ Firebase baÄŸlantÄ±sÄ± yapÄ±landÄ±rÄ±ldÄ±</div>
      <div class="form-group">
        <label>E-Posta</label>
        <input type="email" id="loginEmail" placeholder="admin@sirket.com" autocomplete="email" autofocus>
      </div>
      <div class="form-group">
        <label>Åifre</label>
        <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
      </div>
      <button class="login-btn" id="loginBtn"><span id="loginBtnTxt">GiriÅŸ Yap â†’</span></button>
      <div class="err-msg" id="loginError"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â• -->
<div id="appScreen">

  <div class="header">
    <div class="header-brand">Lisans<span>Takip</span></div>
    <div class="header-right">
      <div class="user-chip" id="userChip">â€”</div>
      <div class="toggle-wrap">
        <span class="theme-icon" id="appThemeIcon">â˜€ï¸</span>
        <button class="theme-toggle" id="appThemeToggle"></button>
      </div>
      <button class="btn btn-sm btn-danger" id="logoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-ico n">ğŸ“‹</div>
      <div><div class="stat-lbl">Toplam Lisans</div><div class="stat-val n" id="statTotal">0</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-ico ok">âœ“</div>
      <div><div class="stat-lbl">Aktif</div><div class="stat-val ok" id="statActive">0</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-ico wa">âš </div>
      <div><div class="stat-lbl">YakÄ±nda Bitiyor</div><div class="stat-val wa" id="statExpiring">0</div></div>
    </div>
    <div class="stat-card">
      <div class="stat-ico da">âœ•</div>
      <div><div class="stat-lbl">SÃ¼resi DolmuÅŸ</div><div class="stat-val da" id="statExpired">0</div></div>
    </div>
  </div>

  <!-- Security notice -->
  <div class="sec-notice" id="secNotice">
    <span>ğŸ”’</span>
    <span>GÃ¼venlik: Firestore kurallarÄ±nÄ±zÄ± test mode'dan production'a alÄ±n.
    <a href="https://console.firebase.google.com/project/license-tracker-fb51b/firestore/rules" target="_blank" rel="noopener" style="color:var(--blue);font-weight:700;">KurallarÄ± dÃ¼zenle â†’</a></span>
  </div>

  <!-- Alert banner -->
  <div class="alert-banner" id="alertBanner">
    <div class="ab-icon">ğŸ””</div>
    <div>
      <div class="ab-title">Dikkat! SÃ¼resi yaklaÅŸan veya dolmuÅŸ lisanslar:</div>
      <ul class="ab-list" id="alertList"></ul>
    </div>
  </div>

  <div class="main">

    <!-- â•â• SIDEBAR â•â• -->
    <div class="sidebar">

      <!-- SECTION 1: Temel Bilgiler -->
      <div class="acc-section open" id="sec1">
        <div class="acc-header" onclick="toggleAcc('sec1')">
          <div class="acc-header-left">
            <span class="acc-header-icon">ğŸ“</span>
            <div>
              <div class="acc-header-title">Temel Bilgiler</div>
              <div class="acc-header-sub">Ä°sim, tedarikÃ§i, kategori</div>
            </div>
          </div>
          <span class="acc-chevron">â–¼</span>
        </div>
        <div class="acc-body">
          <div class="form-group">
            <label>YazÄ±lÄ±m / ÃœrÃ¼n AdÄ± <span style="color:var(--danger)">*</span></label>
            <input type="text" id="f_name" placeholder="Microsoft Office 365" maxlength="120">
          </div>
          <div class="form-group">
            <label>TedarikÃ§i</label>
            <input type="text" id="f_vendor" placeholder="Microsoft" maxlength="80">
          </div>
          <div class="form-group">
            <label>Kategori</label>
            <select id="f_category">
              <option value="">â€” SeÃ§in â€”</option>
              <option>Ä°ÅŸletim Sistemi</option>
              <option>Ofis &amp; Verimlilik</option>
              <option>GÃ¼venlik</option>
              <option>GeliÅŸtirme AraÃ§larÄ±</option>
              <option>TasarÄ±m</option>
              <option>ERP / CRM</option>
              <option>Bulut &amp; AltyapÄ±</option>
              <option>DiÄŸer</option>
            </select>
          </div>
          <div class="form-group">
            <label>Lisans AnahtarÄ±</label>
            <input type="text" id="f_licenseKey" placeholder="XXXXX-XXXXX-XXXXX" maxlength="120" autocomplete="off">
          </div>
        </div>
      </div>

      <!-- SECTION 2: Tarih & Miktar -->
      <div class="acc-section" id="sec2">
        <div class="acc-header" onclick="toggleAcc('sec2')">
          <div class="acc-header-left">
            <span class="acc-header-icon">ğŸ“…</span>
            <div>
              <div class="acc-header-title">Tarih &amp; Miktar</div>
              <div class="acc-header-sub">BaÅŸlangÄ±Ã§, bitiÅŸ, adet</div>
            </div>
          </div>
          <span class="acc-chevron">â–¼</span>
        </div>
        <div class="acc-body">
          <div class="form-group">
            <label>BaÅŸlangÄ±Ã§ Tarihi</label>
            <input type="date" id="f_startDate">
          </div>
          <div class="form-group">
            <label>BitiÅŸ Tarihi <span style="color:var(--danger)">*</span></label>
            <input type="date" id="f_endDate">
          </div>
          <div class="form-group">
            <label>Lisans Adedi</label>
            <input type="number" id="f_count" placeholder="1" min="1" max="99999">
          </div>
          <div class="form-group">
            <label>UyarÄ± EÅŸiÄŸi (gÃ¼n)</label>
            <div class="input-wrap has-suffix">
              <input type="number" id="f_warnDays" value="30" min="1" max="365">
              <span class="input-suffix">gÃ¼n</span>
            </div>
          </div>
        </div>
      </div>

      <!-- SECTION 3: Maliyet -->
      <div class="acc-section" id="sec3">
        <div class="acc-header" onclick="toggleAcc('sec3')">
          <div class="acc-header-left">
            <span class="acc-header-icon">ğŸ’°</span>
            <div>
              <div class="acc-header-title">Maliyet</div>
              <div class="acc-header-sub">Birim fiyat, toplam</div>
            </div>
          </div>
          <span class="acc-chevron">â–¼</span>
        </div>
        <div class="acc-body">
          <div class="form-group">
            <label>Birim Lisans Maliyeti</label>
            <div class="input-wrap has-prefix">
              <span class="input-prefix">â‚º</span>
              <input type="number" id="f_cost" placeholder="0.00" min="0" step="0.01">
            </div>
          </div>
          <div class="form-group">
            <label>Para Birimi</label>
            <select id="f_currency">
              <option value="TRY">â‚º TÃ¼rk LirasÄ±</option>
              <option value="USD">$ Dolar</option>
              <option value="EUR">â‚¬ Euro</option>
            </select>
          </div>
          <div id="costPreview" style="display:none;padding:.6rem .75rem;background:var(--ok-bg);border:1px solid var(--ok);border-radius:6px;font-size:.75rem;color:var(--ok);font-family:'DM Mono',monospace;margin-top:.25rem;"></div>
        </div>
      </div>

      <!-- SECTION 4: Sorumlu & Notlar -->
      <div class="acc-section" id="sec4">
        <div class="acc-header" onclick="toggleAcc('sec4')">
          <div class="acc-header-left">
            <span class="acc-header-icon">ğŸ‘¤</span>
            <div>
              <div class="acc-header-title">Sorumlu &amp; Notlar</div>
              <div class="acc-header-sub">KiÅŸi, birim, aÃ§Ä±klama</div>
            </div>
          </div>
          <span class="acc-chevron">â–¼</span>
        </div>
        <div class="acc-body">
          <div class="form-group">
            <label>Atanan KiÅŸi / Birim</label>
            <input type="text" id="f_assignee" placeholder="IT DepartmanÄ±" maxlength="80">
          </div>
          <div class="form-group">
            <label>Notlar</label>
            <textarea id="f_notes" placeholder="Ek bilgi, sÃ¶zleÅŸme detaylarÄ±..." rows="3" maxlength="500" style="resize:vertical;"></textarea>
          </div>
        </div>
      </div>

      <div class="sidebar-save-wrap">
        <button class="btn btn-accent btn-full" id="addBtn">
          <span id="addBtnTxt">ğŸ’¾ LisansÄ± Kaydet</span>
        </button>
      </div>
    </div>

    <!-- â•â• CONTENT â•â• -->
    <div class="content-area">
      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-ico">ğŸ”</span>
          <input type="text" id="searchInput" placeholder="Ara...">
        </div>
        <div class="filter-pills">
          <button class="filter-pill active" data-filter="all">TÃ¼mÃ¼</button>
          <button class="filter-pill" data-filter="active">Aktif</button>
          <button class="filter-pill" data-filter="expiring">YakÄ±nda</button>
          <button class="filter-pill" data-filter="expired">DolmuÅŸ</button>
        </div>
        <div class="toolbar-right">
          <div class="cost-summary" id="costSummary" style="display:none">
            ğŸ’° Toplam: <strong id="totalCostVal">â€”</strong>
          </div>
          <button class="btn btn-sm btn-ghost" id="exportBtn" title="CSV Ä°ndir">â¬‡ CSV</button>
          <div class="loading-wrap" id="tableLoading"><div class="spinner"></div> YÃ¼kleniyor</div>
        </div>
      </div>

      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th>YazÄ±lÄ±m</th>
              <th>TedarikÃ§i</th>
              <th>Kategori</th>
              <th>Adet</th>
              <th>BitiÅŸ</th>
              <th>Kalan</th>
              <th>Ã–mÃ¼r</th>
              <th>Durum</th>
              <th>Maliyet</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="licenseTable">
            <tr><td colspan="10">
              <div class="empty-state">
                <div class="empty-ico">ğŸ“‹</div>
                <div class="empty-title">HenÃ¼z lisans yok</div>
                <div class="empty-sub">Sol panelden yeni lisans ekleyin</div>
              </div>
            </td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- â•â• EDIT MODAL â•â• -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">âœï¸ LisansÄ± DÃ¼zenle</div>
    <div class="modal-grid">
      <div class="full"><label>YazÄ±lÄ±m / ÃœrÃ¼n AdÄ±</label><input type="text" id="e_name" maxlength="120"></div>
      <div class="full"><label>TedarikÃ§i</label><input type="text" id="e_vendor" maxlength="80"></div>
      <div>
        <label>BitiÅŸ Tarihi</label>
        <input type="date" id="e_endDate">
      </div>
      <div><label>Lisans Adedi</label><input type="number" id="e_count" min="1"></div>
      <div>
        <label>Birim Maliyet</label>
        <div class="input-wrap has-prefix">
          <span class="input-prefix">â‚º</span>
          <input type="number" id="e_cost" min="0" step="0.01">
        </div>
      </div>
      <div>
        <label>UyarÄ± EÅŸiÄŸi</label>
        <div class="input-wrap has-suffix">
          <input type="number" id="e_warnDays" min="1" max="365">
          <span class="input-suffix">gÃ¼n</span>
        </div>
      </div>
      <div class="full"><label>Atanan KiÅŸi / Birim</label><input type="text" id="e_assignee" maxlength="80"></div>
      <div class="full"><label>Notlar</label><textarea id="e_notes" rows="2" maxlength="500" style="resize:vertical;"></textarea></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="closeEdit">Ä°ptal</button>
      <button class="btn btn-accent" id="saveEdit">Kaydet</button>
    </div>
  </div>
</div>

<!-- â•â• DETAIL MODAL â•â• -->
<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <div class="modal-title">ğŸ” Lisans DetayÄ±</div>
    <div id="detailContent"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="closeDetail">Kapat</button>
    </div>
  </div>
</div>

<script>
'use strict';
/* â”€â”€ State â”€â”€ */
let licenses = [], filter = 'all', query = '', editingId = null, FB = null;

/* â•â• THEME â•â• */
function applyTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  const ic = t === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
  ['themeIcon','appThemeIcon'].forEach(id => { const el = document.getElementById(id); if (el) el.textContent = ic; });
  try { localStorage.setItem('lt_theme', t); } catch(_) {}
}
function toggleTheme() { applyTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
try { applyTheme(localStorage.getItem('lt_theme') || 'light'); } catch(_) { applyTheme('light'); }
['themeToggle','appThemeToggle'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('click', toggleTheme);
});

/* â•â• ACCORDION â•â• */
function toggleAcc(id) {
  const el = document.getElementById(id);
  el.classList.toggle('open');
}
window.toggleAcc = toggleAcc;

/* â•â• COST PREVIEW â•â• */
function updateCostPreview() {
  const cost  = parseFloat(document.getElementById('f_cost').value)  || 0;
  const count = parseInt(document.getElementById('f_count').value)   || 1;
  const curr  = document.getElementById('f_currency').value || 'TRY';
  const sym   = { TRY:'â‚º', USD:'$', EUR:'â‚¬' }[curr] || 'â‚º';
  const prev  = document.getElementById('costPreview');
  if (cost > 0) {
    const total = cost * count;
    prev.style.display = 'block';
    prev.textContent = `Toplam: ${sym}${total.toLocaleString('tr-TR', { minimumFractionDigits:2, maximumFractionDigits:2 })} (${count} Ã— ${sym}${cost.toLocaleString('tr-TR', { minimumFractionDigits:2 })})`;
  } else {
    prev.style.display = 'none';
  }
}
['f_cost','f_count','f_currency'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', updateCostPreview);
});

/* â•â• FIREBASE â•â• */
window.addEventListener('firebaseReady', () => {
  FB = window._fb;
  window._appReady = loadLicenses;

  document.getElementById('loginBtn').addEventListener('click', doLogin);
  document.getElementById('loginPass').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
  document.getElementById('logoutBtn').addEventListener('click', doLogout);

  // If already signed in (onAuthStateChanged fired before this)
  if (window._fbUser) loadLicenses();
});

/* â”€â”€ Input sanitize (strip HTML tags) â”€â”€ */
function sanitize(s) {
  return String(s || '').replace(/[<>"'`]/g, c => ({'<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#x27;','`':'&#x60;'}[c]));
}

/* â”€â”€ Safe text node â”€â”€ */
function txt(s) { return document.createTextNode(String(s || '')); }

/* â”€â”€ Escape for HTML attribute strings â”€â”€ */
function esc(s) {
  return String(s || '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#x27;');
}

async function doLogin() {
  const email  = document.getElementById('loginEmail').value.trim();
  const pass   = document.getElementById('loginPass').value;
  const errEl  = document.getElementById('loginError');
  const btn    = document.getElementById('loginBtn');
  errEl.style.display = 'none';

  if (!email || !pass) { showLoginErr('E-posta ve ÅŸifre gerekli.'); return; }

  document.getElementById('loginBtnTxt').innerHTML =
    '<span style="display:flex;align-items:center;justify-content:center;gap:.5rem"><span class="spinner"></span>BaÄŸlanÄ±yor...</span>';
  btn.disabled = true;

  try {
    const cred = await FB.signInWithEmailAndPassword(FB.auth, email, pass);
    document.getElementById('userChip').textContent = cred.user.email;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').style.display   = 'block';
    await loadLicenses();
  } catch (err) {
    const msgs = {
      'auth/wrong-password':       'Åifre yanlÄ±ÅŸ.',
      'auth/invalid-credential':   'E-posta veya ÅŸifre hatalÄ±.',
      'auth/user-not-found':       'KullanÄ±cÄ± bulunamadÄ±.',
      'auth/invalid-email':        'GeÃ§ersiz e-posta adresi.',
      'auth/too-many-requests':    'Ã‡ok fazla deneme. LÃ¼tfen birkaÃ§ dakika bekleyin.',
      'auth/network-request-failed':'AÄŸ hatasÄ±. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.',
      'auth/configuration-not-found':'Firebase Authentication etkin deÄŸil.\nConsole â†’ Authentication â†’ Sign-in method â†’ Email/Password â†’ Enable.',
    };
    showLoginErr(msgs[err.code] || err.message);
  }
  document.getElementById('loginBtnTxt').textContent = 'GiriÅŸ Yap â†’';
  btn.disabled = false;
}

function showLoginErr(msg) {
  const el = document.getElementById('loginError');
  el.textContent = msg;
  el.style.display = 'block';
}

async function doLogout() {
  try { await FB.signOut(FB.auth); } catch(_) {}
  licenses = [];
  document.getElementById('appScreen').style.display   = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPass').value  = '';
}

/* â•â• LOAD â•â• */
async function loadLicenses() {
  const loader = document.getElementById('tableLoading');
  loader.style.display = 'flex';
  try {
    let snap;
    try {
      snap = await FB.getDocs(FB.query(FB.collection(FB.db, 'licenses'), FB.orderBy('endDate','asc')));
    } catch {
      snap = await FB.getDocs(FB.collection(FB.db, 'licenses'));
    }
    licenses = snap.docs.map(d => {
      const data = d.data();
      // Sanitize incoming data for display safety
      return {
        id:         d.id,
        name:       String(data.name        || ''),
        vendor:     String(data.vendor      || ''),
        category:   String(data.category    || ''),
        count:      parseInt(data.count)    || 1,
        cost:       parseFloat(data.cost)   || 0,
        currency:   String(data.currency    || 'TRY'),
        startDate:  String(data.startDate   || ''),
        endDate:    String(data.endDate     || ''),
        licenseKey: String(data.licenseKey  || ''),
        assignee:   String(data.assignee    || ''),
        notes:      String(data.notes       || ''),
        warnDays:   parseInt(data.warnDays) || 30,
        createdAt:  data.createdAt          || '',
      };
    });
    licenses.sort((a,b) => new Date(a.endDate) - new Date(b.endDate));
    renderTable(); updateStats(); renderAlerts(); renderCostSummary();
    // Show security notice once (test mode reminder)
    document.getElementById('secNotice').classList.add('show');
  } catch(e) {
    console.error('[LisansTakip] YÃ¼kleme hatasÄ±:', e);
  }
  loader.style.display = 'none';
}

/* â•â• VALIDATION â•â• */
function validateForm() {
  const name    = document.getElementById('f_name').value.trim();
  const endDate = document.getElementById('f_endDate').value;
  if (!name)    { alert('âš  YazÄ±lÄ±m adÄ± zorunlu!');    document.getElementById('f_name').focus();    return false; }
  if (!endDate) { alert('âš  BitiÅŸ tarihi zorunlu!');   document.getElementById('f_endDate').focus(); return false; }
  return true;
}

/* â•â• ADD â•â• */
document.getElementById('addBtn').addEventListener('click', async () => {
  if (!validateForm()) return;
  const data = {
    name:       document.getElementById('f_name').value.trim().slice(0,120),
    vendor:     document.getElementById('f_vendor').value.trim().slice(0,80),
    category:   document.getElementById('f_category').value,
    count:      Math.max(1, parseInt(document.getElementById('f_count').value) || 1),
    cost:       Math.max(0, parseFloat(document.getElementById('f_cost').value) || 0),
    currency:   document.getElementById('f_currency').value || 'TRY',
    startDate:  document.getElementById('f_startDate').value,
    endDate:    document.getElementById('f_endDate').value,
    licenseKey: document.getElementById('f_licenseKey').value.trim().slice(0,120),
    assignee:   document.getElementById('f_assignee').value.trim().slice(0,80),
    notes:      document.getElementById('f_notes').value.trim().slice(0,500),
    warnDays:   Math.min(365, Math.max(1, parseInt(document.getElementById('f_warnDays').value) || 30)),
    createdAt:  FB.serverTimestamp(),
  };

  const btn = document.getElementById('addBtn');
  document.getElementById('addBtnTxt').innerHTML = '<span class="spinner" style="display:inline-block"></span> Kaydediliyor...';
  btn.disabled = true;

  try {
    await FB.addDoc(FB.collection(FB.db,'licenses'), data);
    // Reset form
    ['f_name','f_vendor','f_licenseKey','f_assignee','f_notes'].forEach(id => document.getElementById(id).value='');
    document.getElementById('f_category').value  = '';
    document.getElementById('f_count').value     = '';
    document.getElementById('f_cost').value      = '';
    document.getElementById('f_currency').value  = 'TRY';
    document.getElementById('f_startDate').value = '';
    document.getElementById('f_endDate').value   = '';
    document.getElementById('f_warnDays').value  = '30';
    document.getElementById('costPreview').style.display = 'none';
    await loadLicenses();
  } catch(e) {
    alert('KayÄ±t hatasÄ±: ' + e.message);
  }
  document.getElementById('addBtnTxt').textContent = 'ğŸ’¾ LisansÄ± Kaydet';
  btn.disabled = false;
});

/* â•â• HELPERS â•â• */
function getStatus(daysLeft, warnDays) {
  if (daysLeft < 0)            return 'expired';
  if (daysLeft <= warnDays)    return 'expiring';
  return 'active';
}

function formatDate(d) {
  if (!d) return 'â€”';
  try { return new Date(d).toLocaleDateString('tr-TR', { day:'2-digit', month:'2-digit', year:'numeric' }); }
  catch { return d; }
}

function formatCurrency(val, curr) {
  const sym = { TRY:'â‚º', USD:'$', EUR:'â‚¬' }[curr] || 'â‚º';
  return sym + val.toLocaleString('tr-TR', { minimumFractionDigits:2, maximumFractionDigits:2 });
}

function lifePercent(l) {
  if (!l.startDate || !l.endDate) return null;
  const start = new Date(l.startDate).getTime();
  const end   = new Date(l.endDate).getTime();
  const now   = Date.now();
  if (end <= start) return null;
  return Math.min(100, Math.max(0, Math.round((now - start) / (end - start) * 100)));
}

/* â•â• RENDER TABLE â•â• */
function renderTable() {
  const tbody  = document.getElementById('licenseTable');
  const today  = new Date(); today.setHours(0,0,0,0);
  const q      = query.toLowerCase();

  const filtered = licenses.filter(l => {
    const d  = Math.ceil((new Date(l.endDate) - today) / 86400000);
    const st = getStatus(d, l.warnDays);
    if (filter !== 'all' && st !== filter) return false;
    if (q) return [l.name, l.vendor, l.category, l.assignee]
      .some(x => x.toLowerCase().includes(q));
    return true;
  });

  if (!filtered.length) {
    tbody.innerHTML = '';
    const tr = tbody.insertRow();
    const td = tr.insertCell();
    td.colSpan = 10;
    td.innerHTML = '<div class="empty-state"><div class="empty-ico">ğŸ”</div><div class="empty-title">SonuÃ§ bulunamadÄ±</div><div class="empty-sub">Filtre veya arama kriterini deÄŸiÅŸtirin</div></div>';
    return;
  }

  tbody.innerHTML = '';

  filtered.forEach(l => {
    const today2 = new Date(); today2.setHours(0,0,0,0);
    const d  = Math.ceil((new Date(l.endDate) - today2) / 86400000);
    const st = getStatus(d, l.warnDays);
    const dc = st === 'expired' ? 'da' : st === 'expiring' ? 'wa' : 'ok';
    const daysText = st === 'expired' ? `${Math.abs(d)}g doldu` : `${d}g kaldÄ±`;

    const pct = lifePercent(l);
    const progColor = st === 'expired' ? 'var(--danger)' : st === 'expiring' ? 'var(--warn)' : 'var(--ok)';

    const totalCost = l.cost * l.count;
    const costStr   = totalCost > 0 ? formatCurrency(totalCost, l.currency) : 'â€”';

    const tr = tbody.insertRow();
    tr.style.animation = 'slideIn .2s ease';

    // YazÄ±lÄ±m
    const td0 = tr.insertCell();
    const nameDiv = document.createElement('div');
    nameDiv.style.fontWeight = '600';
    nameDiv.appendChild(txt(l.name));
    td0.appendChild(nameDiv);
    if (l.licenseKey) {
      const keyDiv = document.createElement('div');
      keyDiv.className = 'mono-sm';
      keyDiv.appendChild(txt(l.licenseKey));
      td0.appendChild(keyDiv);
    }

    // TedarikÃ§i
    const td1 = tr.insertCell();
    td1.className = 'soft';
    td1.appendChild(txt(l.vendor || 'â€”'));

    // Kategori
    const td2 = tr.insertCell();
    if (l.category) {
      const b = document.createElement('span');
      b.className = 'badge b-bl';
      b.appendChild(txt(l.category));
      td2.appendChild(b);
    } else {
      td2.innerHTML = '<span class="soft">â€”</span>';
    }

    // Adet
    const td3 = tr.insertCell();
    td3.style.fontFamily = "'DM Mono',monospace";
    td3.style.fontSize   = '.82rem';
    td3.appendChild(txt(l.count));

    // BitiÅŸ
    const td4 = tr.insertCell();
    td4.style.fontFamily = "'DM Mono',monospace";
    td4.style.fontSize   = '.78rem';
    td4.appendChild(txt(formatDate(l.endDate)));

    // Kalan
    const td5 = tr.insertCell();
    const chip = document.createElement('span');
    chip.className = `days-chip ${dc}`;
    chip.appendChild(txt(daysText));
    td5.appendChild(chip);

    // Progress (Ã¶mÃ¼r)
    const td6 = tr.insertCell();
    if (pct !== null) {
      const wrap = document.createElement('div');
      wrap.className = 'progress-wrap';
      const bar = document.createElement('div');
      bar.className = 'progress-bar';
      bar.style.width = pct + '%';
      bar.style.background = progColor;
      wrap.appendChild(bar);
      td6.appendChild(wrap);
    } else {
      td6.innerHTML = '<span class="soft">â€”</span>';
    }

    // Durum
    const td7 = tr.insertCell();
    const badge = document.createElement('span');
    if (st === 'expired') { badge.className = 'badge b-da'; badge.textContent = 'âœ• DolmuÅŸ'; }
    else if (st === 'expiring') { badge.className = 'badge b-wa'; badge.textContent = 'âš  YakÄ±nda'; }
    else { badge.className = 'badge b-ok'; badge.textContent = 'âœ“ Aktif'; }
    td7.appendChild(badge);

    // Maliyet
    const td8 = tr.insertCell();
    td8.style.fontFamily = "'DM Mono',monospace";
    td8.style.fontSize   = '.78rem';
    td8.appendChild(txt(costStr));

    // Actions
    const td9 = tr.insertCell();
    const actDiv = document.createElement('div');
    actDiv.className = 'actions';

    const viewBtn = document.createElement('button');
    viewBtn.className = 'act-btn view';
    viewBtn.title = 'Detay';
    viewBtn.textContent = 'ğŸ”';
    viewBtn.addEventListener('click', () => openDetail(l.id));

    const editBtn = document.createElement('button');
    editBtn.className = 'act-btn';
    editBtn.title = 'DÃ¼zenle';
    editBtn.textContent = 'âœï¸';
    editBtn.addEventListener('click', () => openEdit(l.id));

    const delBtn = document.createElement('button');
    delBtn.className = 'act-btn del';
    delBtn.title = 'Sil';
    delBtn.textContent = 'ğŸ—‘ï¸';
    delBtn.addEventListener('click', () => deleteLicense(l.id, l.name));

    actDiv.appendChild(viewBtn);
    actDiv.appendChild(editBtn);
    actDiv.appendChild(delBtn);
    td9.appendChild(actDiv);
  });
}

/* â•â• STATS â•â• */
function updateStats() {
  const today = new Date(); today.setHours(0,0,0,0);
  let a=0, e=0, x=0;
  licenses.forEach(l => {
    const d  = Math.ceil((new Date(l.endDate) - today) / 86400000);
    const st = getStatus(d, l.warnDays);
    if (st==='active') a++; else if (st==='expiring') e++; else x++;
  });
  document.getElementById('statTotal').textContent    = licenses.length;
  document.getElementById('statActive').textContent   = a;
  document.getElementById('statExpiring').textContent = e;
  document.getElementById('statExpired').textContent  = x;
}

/* â•â• COST SUMMARY â•â• */
function renderCostSummary() {
  if (!licenses.length) { document.getElementById('costSummary').style.display='none'; return; }
  // Group by currency
  const totals = {};
  licenses.forEach(l => {
    const c = l.currency || 'TRY';
    totals[c] = (totals[c] || 0) + (l.cost * l.count);
  });
  const parts = Object.entries(totals)
    .filter(([,v]) => v > 0)
    .map(([c,v]) => formatCurrency(v, c))
    .join(' + ');
  if (parts) {
    document.getElementById('totalCostVal').textContent = parts;
    document.getElementById('costSummary').style.display = 'flex';
  }
}

/* â•â• ALERTS â•â• */
function renderAlerts() {
  const today  = new Date(); today.setHours(0,0,0,0);
  const banner = document.getElementById('alertBanner');
  const list   = document.getElementById('alertList');

  const urgent = licenses
    .filter(l => getStatus(Math.ceil((new Date(l.endDate)-today)/86400000), l.warnDays) !== 'active')
    .sort((a,b) => new Date(a.endDate) - new Date(b.endDate));

  list.innerHTML = '';

  if (urgent.length) {
    banner.classList.add('show');
    urgent.forEach(l => {
      const d  = Math.ceil((new Date(l.endDate)-today)/86400000);
      const li = document.createElement('li');
      const strong = document.createElement('strong');
      strong.appendChild(txt(l.name));
      li.appendChild(strong);
      li.appendChild(txt(' â€” ' + (d<0 ? Math.abs(d)+' gÃ¼n Ã¶nce doldu' : d+' gÃ¼n kaldÄ± ('+formatDate(l.endDate)+')')));
      list.appendChild(li);
    });
  } else {
    banner.classList.remove('show');
  }
}

/* â•â• DELETE â•â• */
async function deleteLicense(id, name) {
  if (!confirm(`"${name}" lisansÄ±nÄ± silmek istediÄŸinize emin misiniz?\nBu iÅŸlem geri alÄ±namaz.`)) return;
  try {
    await FB.deleteDoc(FB.doc(FB.db,'licenses',id));
    await loadLicenses();
  } catch(e) { alert('Silme hatasÄ±: '+e.message); }
}

/* â•â• EDIT MODAL â•â• */
function openEdit(id) {
  const l = licenses.find(x => x.id === id);
  if (!l) return;
  editingId = id;
  document.getElementById('e_name').value     = l.name;
  document.getElementById('e_vendor').value   = l.vendor;
  document.getElementById('e_endDate').value  = l.endDate;
  document.getElementById('e_count').value    = l.count;
  document.getElementById('e_cost').value     = l.cost;
  document.getElementById('e_warnDays').value = l.warnDays;
  document.getElementById('e_assignee').value = l.assignee;
  document.getElementById('e_notes').value    = l.notes;
  document.getElementById('editModal').classList.add('open');
}

document.getElementById('closeEdit').addEventListener('click', () => document.getElementById('editModal').classList.remove('open'));

document.getElementById('saveEdit').addEventListener('click', async () => {
  if (!editingId) return;
  const updates = {
    name:     document.getElementById('e_name').value.trim().slice(0,120),
    vendor:   document.getElementById('e_vendor').value.trim().slice(0,80),
    endDate:  document.getElementById('e_endDate').value,
    count:    Math.max(1, parseInt(document.getElementById('e_count').value) || 1),
    cost:     Math.max(0, parseFloat(document.getElementById('e_cost').value) || 0),
    warnDays: Math.min(365, Math.max(1, parseInt(document.getElementById('e_warnDays').value) || 30)),
    assignee: document.getElementById('e_assignee').value.trim().slice(0,80),
    notes:    document.getElementById('e_notes').value.trim().slice(0,500),
  };
  try {
    await FB.updateDoc(FB.doc(FB.db,'licenses',editingId), updates);
    document.getElementById('editModal').classList.remove('open');
    await loadLicenses();
  } catch(e) { alert('GÃ¼ncelleme hatasÄ±: '+e.message); }
});

/* â•â• DETAIL MODAL â•â• */
function openDetail(id) {
  const l = licenses.find(x => x.id === id);
  if (!l) return;
  const today = new Date(); today.setHours(0,0,0,0);
  const d  = Math.ceil((new Date(l.endDate) - today) / 86400000);
  const st = getStatus(d, l.warnDays);

  const rows = [
    ['YazÄ±lÄ±m AdÄ±',      l.name],
    ['TedarikÃ§i',        l.vendor || 'â€”'],
    ['Kategori',         l.category || 'â€”'],
    ['Lisans Adedi',     l.count],
    ['Birim Maliyet',    l.cost > 0 ? formatCurrency(l.cost, l.currency) : 'â€”'],
    ['Toplam Maliyet',   l.cost > 0 ? formatCurrency(l.cost * l.count, l.currency) : 'â€”'],
    ['BaÅŸlangÄ±Ã§',        formatDate(l.startDate) || 'â€”'],
    ['BitiÅŸ Tarihi',     formatDate(l.endDate)],
    ['Kalan / GeÃ§en',    d < 0 ? Math.abs(d)+' gÃ¼n Ã¶nce doldu' : d+' gÃ¼n kaldÄ±'],
    ['Durum',            st === 'expired' ? 'âœ• DolmuÅŸ' : st === 'expiring' ? 'âš  YakÄ±nda Bitiyor' : 'âœ“ Aktif'],
    ['UyarÄ± EÅŸiÄŸi',      l.warnDays + ' gÃ¼n'],
    ['Atanan',           l.assignee || 'â€”'],
    ['Lisans AnahtarÄ±',  l.licenseKey || 'â€”'],
    ['Notlar',           l.notes || 'â€”'],
  ];

  const container = document.getElementById('detailContent');
  container.innerHTML = '';
  rows.forEach(([k,v]) => {
    const row = document.createElement('div');
    row.className = 'detail-row';
    const key = document.createElement('div');
    key.className = 'detail-key';
    key.appendChild(txt(k));
    const val = document.createElement('div');
    val.className = 'detail-val';
    val.appendChild(txt(v));
    row.appendChild(key);
    row.appendChild(val);
    container.appendChild(row);
  });
  document.getElementById('detailModal').classList.add('open');
}

document.getElementById('closeDetail').addEventListener('click', () => document.getElementById('detailModal').classList.remove('open'));

// Close modals on overlay click
['editModal','detailModal'].forEach(id => {
  document.getElementById(id).addEventListener('click', e => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
  });
});

/* â•â• SEARCH & FILTER â•â• */
document.getElementById('searchInput').addEventListener('input', e => {
  query = e.target.value;
  renderTable();
});

document.querySelectorAll('.filter-pill').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    filter = btn.dataset.filter;
    renderTable();
  });
});

/* â•â• CSV EXPORT â•â• */
document.getElementById('exportBtn').addEventListener('click', () => {
  if (!licenses.length) { alert('DÄ±ÅŸa aktarÄ±lacak lisans yok.'); return; }
  const headers = ['Ad','TedarikÃ§i','Kategori','Adet','BaÅŸlangÄ±Ã§','BitiÅŸ','Kalan GÃ¼n','Durum','Birim Maliyet','Toplam Maliyet','Para Birimi','Atanan','Lisans AnahtarÄ±','Notlar'];
  const today   = new Date(); today.setHours(0,0,0,0);

  const rows = licenses.map(l => {
    const d  = Math.ceil((new Date(l.endDate) - today) / 86400000);
    const st = getStatus(d, l.warnDays);
    const statusTr = { active:'Aktif', expiring:'YakÄ±nda Bitiyor', expired:'SÃ¼resi DolmuÅŸ' }[st];
    return [
      l.name, l.vendor, l.category, l.count, l.startDate, l.endDate, d, statusTr,
      l.cost, l.cost * l.count, l.currency, l.assignee, l.licenseKey, l.notes
    ].map(v => '"' + String(v||'').replace(/"/g,'""') + '"').join(',');
  });

  const csv  = '\uFEFF' + headers.join(',') + '\n' + rows.join('\n'); // BOM for Excel Turkish chars
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `lisanstakip_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1000);
});

/* â•â• KEYBOARD SHORTCUTS â•â• */
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.getElementById('editModal').classList.remove('open');
    document.getElementById('detailModal').classList.remove('open');
  }
});
</script>
</body>
</html>
