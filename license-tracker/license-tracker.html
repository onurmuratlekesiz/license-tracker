<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LisansTakip ‚Äî Envanter Sistemi</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

window._firebaseModules = { initializeApp, getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged };
window.dispatchEvent(new Event('firebaseReady'));
</script>

<style>
:root {
  --bg: #0a0a0f;
  --surface: #111118;
  --surface2: #1a1a25;
  --border: #2a2a3a;
  --accent: #e8ff47;
  --accent2: #ff6b47;
  --accent3: #47b8ff;
  --text: #f0f0f8;
  --muted: #666680;
  --danger: #ff3b3b;
  --warn: #ffb347;
  --ok: #47ff8f;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Syne', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* NOISE TEXTURE */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 1000;
  opacity: 0.4;
}

/* LOGIN SCREEN */
#loginScreen {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  background: radial-gradient(ellipse at 30% 50%, #1a1a2e 0%, var(--bg) 70%);
}

.login-card {
  width: 100%;
  max-width: 480px;
  border: 1px solid var(--border);
  background: var(--surface);
  padding: 3rem;
  position: relative;
  overflow: hidden;
}

.login-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--accent), var(--accent3));
}

.brand {
  margin-bottom: 3rem;
}

.brand-tag {
  font-family: 'Space Mono', monospace;
  font-size: 0.65rem;
  color: var(--accent);
  letter-spacing: 0.3em;
  text-transform: uppercase;
  margin-bottom: 0.5rem;
}

.brand h1 {
  font-size: 2rem;
  font-weight: 800;
  letter-spacing: -0.03em;
  line-height: 1;
}

.brand h1 span { color: var(--accent); }

.firebase-config {
  background: var(--surface2);
  border: 1px solid var(--border);
  padding: 1.5rem;
  margin-bottom: 2rem;
}

.config-title {
  font-family: 'Space Mono', monospace;
  font-size: 0.65rem;
  color: var(--accent3);
  letter-spacing: 0.2em;
  text-transform: uppercase;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.config-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
}

.config-grid .full { grid-column: 1/-1; }

label {
  display: block;
  font-family: 'Space Mono', monospace;
  font-size: 0.6rem;
  color: var(--muted);
  letter-spacing: 0.15em;
  text-transform: uppercase;
  margin-bottom: 0.35rem;
}

input, select {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.6rem 0.75rem;
  font-family: 'Space Mono', monospace;
  font-size: 0.75rem;
  outline: none;
  transition: border-color 0.2s;
}

input:focus, select:focus {
  border-color: var(--accent);
}

input::placeholder { color: var(--muted); }

.login-fields { margin-bottom: 1.5rem; }

.btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.8rem 1.5rem;
  font-family: 'Syne', sans-serif;
  font-size: 0.85rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
  text-transform: uppercase;
}

.btn-primary {
  background: var(--accent);
  color: var(--bg);
  width: 100%;
  justify-content: center;
}

.btn-primary:hover {
  background: #d4e832;
  transform: translateY(-1px);
}

.btn-danger {
  background: transparent;
  border: 1px solid var(--danger);
  color: var(--danger);
  padding: 0.5rem 1rem;
  font-size: 0.75rem;
}

.btn-danger:hover { background: var(--danger); color: white; }

.btn-ghost {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
  padding: 0.5rem 1rem;
  font-size: 0.75rem;
}

.btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

.btn-accent {
  background: var(--accent);
  color: var(--bg);
  padding: 0.6rem 1.2rem;
  font-size: 0.8rem;
}

.btn-accent:hover { background: #d4e832; }

.error-msg {
  color: var(--danger);
  font-family: 'Space Mono', monospace;
  font-size: 0.7rem;
  margin-top: 1rem;
  padding: 0.75rem;
  background: rgba(255,59,59,0.1);
  border: 1px solid rgba(255,59,59,0.3);
  display: none;
}

/* APP SCREEN */
#appScreen { display: none; }

.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1.25rem 2rem;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-brand {
  font-size: 1.1rem;
  font-weight: 800;
  letter-spacing: -0.02em;
}

.header-brand span { color: var(--accent); }

.header-right {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.user-chip {
  font-family: 'Space Mono', monospace;
  font-size: 0.65rem;
  color: var(--muted);
  padding: 0.4rem 0.75rem;
  border: 1px solid var(--border);
}

/* STATS BAR */
.stats-bar {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  border-bottom: 1px solid var(--border);
}

.stat-item {
  padding: 1.5rem 2rem;
  border-right: 1px solid var(--border);
  position: relative;
  overflow: hidden;
}

.stat-item:last-child { border-right: none; }

.stat-label {
  font-family: 'Space Mono', monospace;
  font-size: 0.6rem;
  color: var(--muted);
  letter-spacing: 0.2em;
  text-transform: uppercase;
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 2.2rem;
  font-weight: 800;
  letter-spacing: -0.04em;
  line-height: 1;
}

.stat-value.ok { color: var(--ok); }
.stat-value.warn { color: var(--warn); }
.stat-value.danger { color: var(--danger); }
.stat-value.neutral { color: var(--text); }

/* MAIN LAYOUT */
.main {
  display: grid;
  grid-template-columns: 320px 1fr;
  min-height: calc(100vh - 130px);
}

.sidebar {
  border-right: 1px solid var(--border);
  padding: 2rem;
  background: var(--surface);
}

.sidebar-title {
  font-family: 'Space Mono', monospace;
  font-size: 0.65rem;
  color: var(--accent);
  letter-spacing: 0.3em;
  text-transform: uppercase;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.form-group { margin-bottom: 1rem; }

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
}

/* ALERTS */
.alert-banner {
  margin: 1rem 2rem 0;
  padding: 1rem 1.5rem;
  border: 1px solid var(--warn);
  background: rgba(255,179,71,0.08);
  display: none;
  align-items: flex-start;
  gap: 1rem;
}

.alert-icon { font-size: 1.2rem; flex-shrink: 0; }

.alert-content { flex: 1; }

.alert-title {
  font-weight: 700;
  font-size: 0.85rem;
  color: var(--warn);
  margin-bottom: 0.25rem;
}

.alert-list {
  font-family: 'Space Mono', monospace;
  font-size: 0.65rem;
  color: var(--muted);
  list-style: none;
}

.alert-list li { padding: 0.15rem 0; }
.alert-list li::before { content: '‚Äî '; color: var(--warn); }

/* TABLE */
.content-area { padding: 2rem; }

.toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.5rem;
  gap: 1rem;
}

.search-wrap {
  flex: 1;
  max-width: 360px;
  position: relative;
}

.search-wrap input {
  padding-left: 2.5rem;
  background: var(--surface);
  border-color: var(--border);
}

.search-icon {
  position: absolute;
  left: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--muted);
  font-size: 0.85rem;
}

.filter-tabs {
  display: flex;
  gap: 0;
  border: 1px solid var(--border);
}

.filter-tab {
  padding: 0.5rem 1rem;
  font-family: 'Space Mono', monospace;
  font-size: 0.65rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  cursor: pointer;
  border: none;
  background: transparent;
  color: var(--muted);
  border-right: 1px solid var(--border);
  transition: all 0.15s;
}

.filter-tab:last-child { border-right: none; }
.filter-tab.active, .filter-tab:hover { background: var(--accent); color: var(--bg); }

.table-wrap {
  border: 1px solid var(--border);
  overflow: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
}

thead th {
  background: var(--surface2);
  padding: 0.75rem 1rem;
  text-align: left;
  font-family: 'Space Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--muted);
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}

tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.15s;
}

tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: var(--surface2); }

tbody td {
  padding: 0.9rem 1rem;
  font-size: 0.85rem;
  vertical-align: middle;
}

.badge {
  display: inline-block;
  padding: 0.25rem 0.6rem;
  font-family: 'Space Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  font-weight: 700;
  border: 1px solid;
}

.badge-ok { color: var(--ok); border-color: rgba(71,255,143,0.3); background: rgba(71,255,143,0.08); }
.badge-warn { color: var(--warn); border-color: rgba(255,179,71,0.3); background: rgba(255,179,71,0.08); }
.badge-danger { color: var(--danger); border-color: rgba(255,59,59,0.3); background: rgba(255,59,59,0.08); }
.badge-info { color: var(--accent3); border-color: rgba(71,184,255,0.3); background: rgba(71,184,255,0.08); }

.days-left {
  font-family: 'Space Mono', monospace;
  font-size: 0.75rem;
  font-weight: 700;
}

.days-left.ok { color: var(--ok); }
.days-left.warn { color: var(--warn); }
.days-left.danger { color: var(--danger); }

.actions { display: flex; gap: 0.5rem; }

.act-btn {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--muted);
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.15s;
}

.act-btn:hover { border-color: var(--accent); color: var(--accent); }
.act-btn.del:hover { border-color: var(--danger); color: var(--danger); }

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: var(--muted);
}

.empty-icon { font-size: 3rem; margin-bottom: 1rem; }
.empty-title { font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem; }
.empty-sub { font-family: 'Space Mono', monospace; font-size: 0.7rem; }

/* MODAL */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  z-index: 500;
  display: none;
  align-items: center;
  justify-content: center;
}

.modal-overlay.open { display: flex; }

.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  width: 100%;
  max-width: 500px;
  padding: 2rem;
  position: relative;
}

.modal::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: var(--accent3);
}

.modal-title {
  font-size: 1.1rem;
  font-weight: 800;
  margin-bottom: 1.5rem;
}

.modal-actions {
  display: flex;
  gap: 0.75rem;
  margin-top: 1.5rem;
  justify-content: flex-end;
}

/* Loading */
.loading {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-family: 'Space Mono', monospace;
  font-size: 0.7rem;
  color: var(--muted);
}

.spinner {
  width: 14px;
  height: 14px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

tbody tr { animation: fadeIn 0.3s ease; }

/* NOTIFICATION DOT */
.notif-dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  background: var(--danger);
  border-radius: 50%;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(1.4); }
}

@media (max-width: 1100px) {
  .main { grid-template-columns: 1fr; }
  .sidebar { border-right: none; border-bottom: 1px solid var(--border); }
  .stats-bar { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 640px) {
  .stats-bar { grid-template-columns: 1fr 1fr; }
  .content-area { padding: 1rem; }
  .sidebar { padding: 1rem; }
  .header { padding: 1rem; }
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-card">
    <div class="brand">
      <div class="brand-tag">‚¨° Envanter Sistemi</div>
      <h1>Lisans<span>Takip</span></h1>
    </div>

    <div class="firebase-config">
      <div class="config-title">
        üî• Firebase Yapƒ±landƒ±rmasƒ±
      </div>
      <div class="config-grid">
        <div class="full">
          <label>API Key</label>
          <input type="text" id="cfg_apiKey" placeholder="AIzaSy...">
        </div>
        <div>
          <label>Auth Domain</label>
          <input type="text" id="cfg_authDomain" placeholder="project.firebaseapp.com">
        </div>
        <div>
          <label>Project ID</label>
          <input type="text" id="cfg_projectId" placeholder="my-project">
        </div>
        <div class="full">
          <label>Storage Bucket</label>
          <input type="text" id="cfg_storageBucket" placeholder="my-project.appspot.com">
        </div>
        <div class="full">
          <label>Messaging Sender ID</label>
          <input type="text" id="cfg_messagingSenderId" placeholder="123456789">
        </div>
        <div class="full">
          <label>App ID</label>
          <input type="text" id="cfg_appId" placeholder="1:123:web:abc">
        </div>
      </div>
    </div>

    <div class="login-fields">
      <div class="form-group">
        <label>E-Posta</label>
        <input type="email" id="loginEmail" placeholder="admin@sirket.com">
      </div>
      <div class="form-group">
        <label>≈ûifre</label>
        <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
    </div>

    <button class="btn btn-primary" id="loginBtn">
      <span id="loginBtnText">Giri≈ü Yap</span>
    </button>

    <div class="error-msg" id="loginError"></div>
  </div>
</div>

<!-- APP SCREEN -->
<div id="appScreen">
  <div class="header">
    <div class="header-brand">Lisans<span>Takip</span></div>
    <div class="header-right">
      <div class="user-chip" id="userChip">‚Äî</div>
      <button class="btn btn-danger" id="logoutBtn">√áƒ±kƒ±≈ü</button>
    </div>
  </div>

  <div class="stats-bar">
    <div class="stat-item">
      <div class="stat-label">Toplam Lisans</div>
      <div class="stat-value neutral" id="statTotal">0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Aktif</div>
      <div class="stat-value ok" id="statActive">0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">‚ö† Yakƒ±nda Bitiyor</div>
      <div class="stat-value warn" id="statExpiring">0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">‚úï S√ºresi Dolmu≈ü</div>
      <div class="stat-value danger" id="statExpired">0</div>
    </div>
  </div>

  <div class="alert-banner" id="alertBanner">
    <div class="alert-icon">üîî</div>
    <div class="alert-content">
      <div class="alert-title">Dikkat! S√ºresi yakla≈üan veya dolmu≈ü lisanslar var:</div>
      <ul class="alert-list" id="alertList"></ul>
    </div>
  </div>

  <div class="main">
    <!-- SIDEBAR: ADD FORM -->
    <div class="sidebar">
      <div class="sidebar-title">Ôºã Yeni Lisans Ekle</div>

      <div class="form-group">
        <label>Yazƒ±lƒ±m / √úr√ºn Adƒ± *</label>
        <input type="text" id="f_name" placeholder="Microsoft Office 365">
      </div>
      <div class="form-group">
        <label>Tedarik√ßi</label>
        <input type="text" id="f_vendor" placeholder="Microsoft">
      </div>
      <div class="form-group">
        <label>Kategori</label>
        <select id="f_category">
          <option value="">‚Äî Se√ßin ‚Äî</option>
          <option value="ƒ∞≈ületim Sistemi">ƒ∞≈ületim Sistemi</option>
          <option value="Ofis & Verimlilik">Ofis & Verimlilik</option>
          <option value="G√ºvenlik">G√ºvenlik</option>
          <option value="Geli≈ütirme Ara√ßlarƒ±">Geli≈ütirme Ara√ßlarƒ±</option>
          <option value="Tasarƒ±m">Tasarƒ±m</option>
          <option value="ERP / CRM">ERP / CRM</option>
          <option value="Bulut & Altyapƒ±">Bulut & Altyapƒ±</option>
          <option value="Diƒüer">Diƒüer</option>
        </select>
      </div>
      <div class="form-row">
        <div>
          <label>Lisans Sayƒ±sƒ±</label>
          <input type="number" id="f_count" placeholder="1" min="1">
        </div>
        <div>
          <label>Birim Maliyet (‚Ç∫)</label>
          <input type="number" id="f_cost" placeholder="0">
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>Ba≈ülangƒ±√ß</label>
          <input type="date" id="f_startDate">
        </div>
        <div>
          <label>Biti≈ü Tarihi *</label>
          <input type="date" id="f_endDate">
        </div>
      </div>
      <div class="form-group">
        <label>Lisans Anahtarƒ±</label>
        <input type="text" id="f_licenseKey" placeholder="XXXXX-XXXXX-XXXXX">
      </div>
      <div class="form-group">
        <label>Atanan Ki≈üi / Birim</label>
        <input type="text" id="f_assignee" placeholder="IT Departmanƒ±">
      </div>
      <div class="form-group">
        <label>Notlar</label>
        <input type="text" id="f_notes" placeholder="Ek bilgi...">
      </div>
      <div class="form-group">
        <label>Uyarƒ± E≈üiƒüi (g√ºn)</label>
        <input type="number" id="f_warnDays" value="30" min="1">
      </div>

      <button class="btn btn-accent" id="addBtn" style="width:100%; justify-content:center;">
        <span id="addBtnText">Lisansƒ± Kaydet</span>
      </button>
    </div>

    <!-- CONTENT: TABLE -->
    <div class="content-area">
      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-icon">üîç</span>
          <input type="text" id="searchInput" placeholder="Ara... (isim, tedarik√ßi, kategori)">
        </div>
        <div class="filter-tabs">
          <button class="filter-tab active" data-filter="all">T√ºm√º</button>
          <button class="filter-tab" data-filter="active">Aktif</button>
          <button class="filter-tab" data-filter="expiring">Yakƒ±nda</button>
          <button class="filter-tab" data-filter="expired">Dolmu≈ü</button>
        </div>
        <div id="tableLoading" class="loading" style="display:none;">
          <div class="spinner"></div> Y√ºkleniyor...
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Yazƒ±lƒ±m</th>
              <th>Tedarik√ßi</th>
              <th>Kategori</th>
              <th>Adet</th>
              <th>Biti≈ü Tarihi</th>
              <th>Kalan G√ºn</th>
              <th>Durum</th>
              <th>Atanan</th>
              <th>ƒ∞≈ülem</th>
            </tr>
          </thead>
          <tbody id="licenseTable">
            <tr><td colspan="9"><div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">Hen√ºz lisans yok</div><div class="empty-sub">Sol panelden yeni lisans ekleyin</div></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">‚úèÔ∏è Lisansƒ± D√ºzenle</div>
    <input type="hidden" id="edit_id">
    <div class="form-group">
      <label>Yazƒ±lƒ±m / √úr√ºn Adƒ±</label>
      <input type="text" id="edit_name">
    </div>
    <div class="form-group">
      <label>Tedarik√ßi</label>
      <input type="text" id="edit_vendor">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
      <div>
        <label>Biti≈ü Tarihi</label>
        <input type="date" id="edit_endDate">
      </div>
      <div>
        <label>Lisans Sayƒ±sƒ±</label>
        <input type="number" id="edit_count">
      </div>
      <div>
        <label>Birim Maliyet (‚Ç∫)</label>
        <input type="number" id="edit_cost">
      </div>
      <div>
        <label>Uyarƒ± E≈üiƒüi (g√ºn)</label>
        <input type="number" id="edit_warnDays">
      </div>
    </div>
    <div class="form-group" style="margin-top:0.75rem;">
      <label>Atanan Ki≈üi / Birim</label>
      <input type="text" id="edit_assignee">
    </div>
    <div class="form-group">
      <label>Notlar</label>
      <input type="text" id="edit_notes">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="closeModal">ƒ∞ptal</button>
      <button class="btn btn-accent" id="saveEditBtn">Kaydet</button>
    </div>
  </div>
</div>

<script>
let db, auth, firebaseModules;
let licenses = [];
let currentFilter = 'all';
let searchQuery = '';
let editingId = null;

// Wait for Firebase to load
window.addEventListener('firebaseReady', initFirebase);

function initFirebase() {
  firebaseModules = window._firebaseModules;
}

// LOGIN
document.getElementById('loginBtn').addEventListener('click', async () => {
  const btn = document.getElementById('loginBtn');
  const btnText = document.getElementById('loginBtnText');
  const errEl = document.getElementById('loginError');
  errEl.style.display = 'none';

  const firebaseConfig = {
    apiKey: document.getElementById('cfg_apiKey').value.trim(),
    authDomain: document.getElementById('cfg_authDomain').value.trim(),
    projectId: document.getElementById('cfg_projectId').value.trim(),
    storageBucket: document.getElementById('cfg_storageBucket').value.trim(),
    messagingSenderId: document.getElementById('cfg_messagingSenderId').value.trim(),
    appId: document.getElementById('cfg_appId').value.trim(),
  };

  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;

  if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
    showError('Firebase yapƒ±landƒ±rma bilgilerini doldurun.');
    return;
  }
  if (!email || !pass) {
    showError('E-posta ve ≈üifre gerekli.');
    return;
  }

  btnText.innerHTML = '<span style="display:flex;align-items:center;gap:0.5rem;"><span style="width:12px;height:12px;border:2px solid rgba(0,0,0,0.3);border-top-color:#000;border-radius:50%;animation:spin 0.6s linear infinite;display:inline-block;"></span> Baƒülanƒ±yor...</span>';
  btn.disabled = true;

  try {
    const { initializeApp } = firebaseModules;
    const { getFirestore } = firebaseModules;
    const { getAuth, signInWithEmailAndPassword } = firebaseModules;

    // Check if already initialized
    let app;
    try {
      const { getApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
      app = getApp();
    } catch {
      app = initializeApp(firebaseConfig);
    }

    auth = getAuth(app);
    db = getFirestore(app);

    const userCred = await signInWithEmailAndPassword(auth, email, pass);
    document.getElementById('userChip').textContent = userCred.user.email;

    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').style.display = 'block';

    loadLicenses();
  } catch (err) {
    let msg = 'Giri≈ü ba≈üarƒ±sƒ±z.';
    if (err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') msg = 'E-posta veya ≈üifre yanlƒ±≈ü.';
    else if (err.code === 'auth/user-not-found') msg = 'Kullanƒ±cƒ± bulunamadƒ±.';
    else if (err.code === 'auth/invalid-api-key') msg = 'Ge√ßersiz API Key.';
    else if (err.code === 'auth/network-request-failed') msg = 'Aƒü hatasƒ±. Baƒülantƒ±yƒ± kontrol edin.';
    else msg = err.message;
    showError(msg);
  }

  btnText.textContent = 'Giri≈ü Yap';
  btn.disabled = false;
});

function showError(msg) {
  const el = document.getElementById('loginError');
  el.textContent = msg;
  el.style.display = 'block';
}

// LOGOUT
document.getElementById('logoutBtn').addEventListener('click', async () => {
  const { signOut } = firebaseModules;
  await signOut(auth);
  document.getElementById('appScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  licenses = [];
});

// LOAD LICENSES
async function loadLicenses() {
  document.getElementById('tableLoading').style.display = 'flex';
  try {
    const { collection, getDocs, query, orderBy } = firebaseModules;
    const q = query(collection(db, 'licenses'), orderBy('endDate', 'asc'));
    const snap = await getDocs(q);
    licenses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderTable();
    updateStats();
    renderAlerts();
  } catch (e) {
    // Try without orderBy if index not ready
    try {
      const { collection, getDocs } = firebaseModules;
      const snap = await getDocs(collection(db, 'licenses'));
      licenses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      licenses.sort((a, b) => new Date(a.endDate) - new Date(b.endDate));
      renderTable();
      updateStats();
      renderAlerts();
    } catch (e2) {
      console.error(e2);
    }
  }
  document.getElementById('tableLoading').style.display = 'none';
}

// ADD LICENSE
document.getElementById('addBtn').addEventListener('click', async () => {
  const name = document.getElementById('f_name').value.trim();
  const endDate = document.getElementById('f_endDate').value;
  if (!name || !endDate) { alert('Yazƒ±lƒ±m adƒ± ve biti≈ü tarihi zorunlu!'); return; }

  const data = {
    name,
    vendor: document.getElementById('f_vendor').value.trim(),
    category: document.getElementById('f_category').value,
    count: parseInt(document.getElementById('f_count').value) || 1,
    cost: parseFloat(document.getElementById('f_cost').value) || 0,
    startDate: document.getElementById('f_startDate').value,
    endDate,
    licenseKey: document.getElementById('f_licenseKey').value.trim(),
    assignee: document.getElementById('f_assignee').value.trim(),
    notes: document.getElementById('f_notes').value.trim(),
    warnDays: parseInt(document.getElementById('f_warnDays').value) || 30,
    createdAt: new Date().toISOString(),
  };

  document.getElementById('addBtnText').textContent = 'Kaydediliyor...';
  document.getElementById('addBtn').disabled = true;

  try {
    const { collection, addDoc } = firebaseModules;
    await addDoc(collection(db, 'licenses'), data);
    clearForm();
    await loadLicenses();
  } catch (e) { alert('Kayƒ±t hatasƒ±: ' + e.message); }

  document.getElementById('addBtnText').textContent = 'Lisansƒ± Kaydet';
  document.getElementById('addBtn').disabled = false;
});

function clearForm() {
  ['f_name','f_vendor','f_licenseKey','f_assignee','f_notes'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('f_category').value = '';
  document.getElementById('f_count').value = '';
  document.getElementById('f_cost').value = '';
  document.getElementById('f_startDate').value = '';
  document.getElementById('f_endDate').value = '';
  document.getElementById('f_warnDays').value = '30';
}

// RENDER TABLE
function renderTable() {
  const tbody = document.getElementById('licenseTable');
  const today = new Date();
  today.setHours(0,0,0,0);

  let filtered = licenses.filter(l => {
    const endDate = new Date(l.endDate);
    const daysLeft = Math.ceil((endDate - today) / 86400000);
    const warnDays = l.warnDays || 30;
    const status = getStatus(daysLeft, warnDays);

    if (currentFilter === 'expired' && status !== 'expired') return false;
    if (currentFilter === 'expiring' && status !== 'expiring') return false;
    if (currentFilter === 'active' && status !== 'active') return false;

    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      return (l.name||'').toLowerCase().includes(q) ||
             (l.vendor||'').toLowerCase().includes(q) ||
             (l.category||'').toLowerCase().includes(q) ||
             (l.assignee||'').toLowerCase().includes(q);
    }
    return true;
  });

  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-title">Sonu√ß bulunamadƒ±</div><div class="empty-sub">Filtre veya arama kriterini deƒüi≈ütirin</div></div></td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(l => {
    const endDate = new Date(l.endDate);
    const daysLeft = Math.ceil((endDate - today) / 86400000);
    const warnDays = l.warnDays || 30;
    const status = getStatus(daysLeft, warnDays);
    const statusBadge = getStatusBadge(status, daysLeft);
    const daysClass = status === 'expired' ? 'danger' : status === 'expiring' ? 'warn' : 'ok';
    const daysText = status === 'expired' ? `${Math.abs(daysLeft)}g √∂nce doldu` : `${daysLeft}g`;

    return `<tr>
      <td><strong>${esc(l.name)}</strong>${l.licenseKey ? `<br><span style="font-family:'Space Mono',monospace;font-size:0.65rem;color:var(--muted)">${esc(l.licenseKey)}</span>` : ''}</td>
      <td>${esc(l.vendor||'‚Äî')}</td>
      <td>${l.category ? `<span class="badge badge-info">${esc(l.category)}</span>` : '‚Äî'}</td>
      <td style="font-family:'Space Mono',monospace;">${l.count||1}</td>
      <td style="font-family:'Space Mono',monospace;font-size:0.8rem;">${formatDate(l.endDate)}</td>
      <td><span class="days-left ${daysClass}">${daysText}</span></td>
      <td>${statusBadge}</td>
      <td style="font-size:0.8rem;">${esc(l.assignee||'‚Äî')}</td>
      <td><div class="actions">
        <button class="act-btn" onclick="openEdit('${l.id}')" title="D√ºzenle">‚úèÔ∏è</button>
        <button class="act-btn del" onclick="deleteLicense('${l.id}')" title="Sil">üóëÔ∏è</button>
      </div></td>
    </tr>`;
  }).join('');
}

function getStatus(daysLeft, warnDays) {
  if (daysLeft < 0) return 'expired';
  if (daysLeft <= warnDays) return 'expiring';
  return 'active';
}

function getStatusBadge(status, daysLeft) {
  if (status === 'expired') return '<span class="badge badge-danger">Dolmu≈ü</span>';
  if (status === 'expiring') return '<span class="badge badge-warn">‚ö† Yakƒ±nda</span>';
  return '<span class="badge badge-ok">Aktif</span>';
}

function formatDate(d) {
  if (!d) return '‚Äî';
  const dt = new Date(d);
  return dt.toLocaleDateString('tr-TR', { day:'2-digit', month:'2-digit', year:'numeric' });
}

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// STATS
function updateStats() {
  const today = new Date();
  today.setHours(0,0,0,0);
  let active = 0, expiring = 0, expired = 0;

  licenses.forEach(l => {
    const daysLeft = Math.ceil((new Date(l.endDate) - today) / 86400000);
    const st = getStatus(daysLeft, l.warnDays || 30);
    if (st === 'active') active++;
    else if (st === 'expiring') expiring++;
    else expired++;
  });

  document.getElementById('statTotal').textContent = licenses.length;
  document.getElementById('statActive').textContent = active;
  document.getElementById('statExpiring').textContent = expiring;
  document.getElementById('statExpired').textContent = expired;
}

// ALERTS
function renderAlerts() {
  const today = new Date();
  today.setHours(0,0,0,0);
  const alertBanner = document.getElementById('alertBanner');
  const alertList = document.getElementById('alertList');

  const urgent = licenses.filter(l => {
    const daysLeft = Math.ceil((new Date(l.endDate) - today) / 86400000);
    const st = getStatus(daysLeft, l.warnDays || 30);
    return st === 'expiring' || st === 'expired';
  }).sort((a,b) => new Date(a.endDate) - new Date(b.endDate));

  if (urgent.length > 0) {
    alertBanner.style.display = 'flex';
    alertList.innerHTML = urgent.map(l => {
      const daysLeft = Math.ceil((new Date(l.endDate) - today) / 86400000);
      const txt = daysLeft < 0
        ? `${l.name} ‚Äî ${Math.abs(daysLeft)} g√ºn √∂nce doldu`
        : `${l.name} ‚Äî ${daysLeft} g√ºn kaldƒ± (${formatDate(l.endDate)})`;
      return `<li>${txt}</li>`;
    }).join('');
  } else {
    alertBanner.style.display = 'none';
  }
}

// DELETE
async function deleteLicense(id) {
  if (!confirm('Bu lisansƒ± silmek istediƒüinize emin misiniz?')) return;
  try {
    const { doc, deleteDoc } = firebaseModules;
    await deleteDoc(doc(db, 'licenses', id));
    await loadLicenses();
  } catch (e) { alert('Silme hatasƒ±: ' + e.message); }
}
window.deleteLicense = deleteLicense;

// EDIT MODAL
function openEdit(id) {
  const l = licenses.find(x => x.id === id);
  if (!l) return;
  editingId = id;
  document.getElementById('edit_id').value = id;
  document.getElementById('edit_name').value = l.name || '';
  document.getElementById('edit_vendor').value = l.vendor || '';
  document.getElementById('edit_endDate').value = l.endDate || '';
  document.getElementById('edit_count').value = l.count || 1;
  document.getElementById('edit_cost').value = l.cost || 0;
  document.getElementById('edit_warnDays').value = l.warnDays || 30;
  document.getElementById('edit_assignee').value = l.assignee || '';
  document.getElementById('edit_notes').value = l.notes || '';
  document.getElementById('editModal').classList.add('open');
}
window.openEdit = openEdit;

document.getElementById('closeModal').addEventListener('click', () => {
  document.getElementById('editModal').classList.remove('open');
});

document.getElementById('saveEditBtn').addEventListener('click', async () => {
  const id = editingId;
  if (!id) return;
  const updates = {
    name: document.getElementById('edit_name').value.trim(),
    vendor: document.getElementById('edit_vendor').value.trim(),
    endDate: document.getElementById('edit_endDate').value,
    count: parseInt(document.getElementById('edit_count').value) || 1,
    cost: parseFloat(document.getElementById('edit_cost').value) || 0,
    warnDays: parseInt(document.getElementById('edit_warnDays').value) || 30,
    assignee: document.getElementById('edit_assignee').value.trim(),
    notes: document.getElementById('edit_notes').value.trim(),
  };
  try {
    const { doc, updateDoc } = firebaseModules;
    await updateDoc(doc(db, 'licenses', id), updates);
    document.getElementById('editModal').classList.remove('open');
    await loadLicenses();
  } catch (e) { alert('G√ºncelleme hatasƒ±: ' + e.message); }
});

// SEARCH & FILTER
document.getElementById('searchInput').addEventListener('input', e => {
  searchQuery = e.target.value;
  renderTable();
});

document.querySelectorAll('.filter-tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    renderTable();
  });
});

// Enter to login
document.getElementById('loginPass').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('loginBtn').click();
});
</script>
</body>
</html>
