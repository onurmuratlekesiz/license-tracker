<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LisansTakip ‚Äî Envanter Sistemi</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { getAuth, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

const firebaseConfig = {
  apiKey: "AIzaSyBGDd-BPvTAbFculUUWCd8Gtgh03cYwzAg",
  authDomain: "license-tracker-fb51b.firebaseapp.com",
  projectId: "license-tracker-fb51b",
  storageBucket: "license-tracker-fb51b.firebasestorage.app",
  messagingSenderId: "284167863677",
  appId: "1:284167863677:web:016c4633561354317c2014"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

window._fb = { db, auth, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, signInWithEmailAndPassword, signOut };
window.dispatchEvent(new Event('firebaseReady'));
</script>

<style>
:root {
  --bg: #0a0a0f;
  --surface: #111118;
  --surface2: #1a1a25;
  --border: #2a2a3a;
  --accent: #e8ff47;
  --accent3: #47b8ff;
  --text: #f0f0f8;
  --muted: #666680;
  --danger: #ff3b3b;
  --warn: #ffb347;
  --ok: #47ff8f;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Syne', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
body::before { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E"); pointer-events: none; z-index: 1000; opacity: 0.4; }

/* LOGIN */
#loginScreen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; background: radial-gradient(ellipse at 30% 50%, #1a1a2e 0%, var(--bg) 70%); }
.login-card { width: 100%; max-width: 420px; border: 1px solid var(--border); background: var(--surface); padding: 3rem; position: relative; overflow: hidden; }
.login-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--accent), var(--accent3)); }
.brand { margin-bottom: 2.5rem; }
.brand-tag { font-family: 'Space Mono', monospace; font-size: 0.65rem; color: var(--accent); letter-spacing: 0.3em; text-transform: uppercase; margin-bottom: 0.5rem; }
.brand h1 { font-size: 2.2rem; font-weight: 800; letter-spacing: -0.03em; line-height: 1; }
.brand h1 span { color: var(--accent); }
.brand-sub { font-family: 'Space Mono', monospace; font-size: 0.62rem; color: var(--muted); margin-top: 0.6rem; }
.firebase-badge { display: flex; align-items: center; gap: 0.6rem; padding: 0.75rem 1rem; background: rgba(71,184,255,0.07); border: 1px solid rgba(71,184,255,0.2); margin-bottom: 2rem; }
.firebase-badge span { font-family: 'Space Mono', monospace; font-size: 0.65rem; color: var(--accent3); }

label { display: block; font-family: 'Space Mono', monospace; font-size: 0.6rem; color: var(--muted); letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 0.35rem; }
input, select { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.75rem 1rem; font-family: 'Space Mono', monospace; font-size: 0.8rem; outline: none; transition: border-color 0.2s; }
input:focus, select:focus { border-color: var(--accent); }
input::placeholder { color: var(--muted); }
.form-group { margin-bottom: 1.25rem; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }

.btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.85rem 1.5rem; font-family: 'Syne', sans-serif; font-size: 0.85rem; font-weight: 700; letter-spacing: 0.05em; cursor: pointer; border: none; transition: all 0.2s; text-transform: uppercase; }
.btn-primary { background: var(--accent); color: var(--bg); width: 100%; justify-content: center; }
.btn-primary:hover { background: #d4e832; transform: translateY(-1px); }
.btn-primary:disabled { opacity: 0.6; transform: none; cursor: not-allowed; }
.btn-danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 0.5rem 1rem; font-size: 0.75rem; }
.btn-danger:hover { background: var(--danger); color: white; }
.btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 0.5rem 1rem; font-size: 0.75rem; }
.btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
.btn-accent { background: var(--accent); color: var(--bg); padding: 0.6rem 1.2rem; font-size: 0.8rem; }
.btn-accent:hover { background: #d4e832; }
.btn-accent:disabled { opacity: 0.6; cursor: not-allowed; }
.error-msg { color: var(--danger); font-family: 'Space Mono', monospace; font-size: 0.7rem; margin-top: 1rem; padding: 0.75rem; background: rgba(255,59,59,0.1); border: 1px solid rgba(255,59,59,0.3); display: none; }

/* APP */
#appScreen { display: none; }
.header { display: flex; align-items: center; justify-content: space-between; padding: 1.25rem 2rem; border-bottom: 1px solid var(--border); background: var(--surface); position: sticky; top: 0; z-index: 100; }
.header-brand { font-size: 1.1rem; font-weight: 800; letter-spacing: -0.02em; }
.header-brand span { color: var(--accent); }
.header-right { display: flex; align-items: center; gap: 1rem; }
.user-chip { font-family: 'Space Mono', monospace; font-size: 0.65rem; color: var(--muted); padding: 0.4rem 0.75rem; border: 1px solid var(--border); }

.stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); border-bottom: 1px solid var(--border); }
.stat-item { padding: 1.5rem 2rem; border-right: 1px solid var(--border); }
.stat-item:last-child { border-right: none; }
.stat-label { font-family: 'Space Mono', monospace; font-size: 0.6rem; color: var(--muted); letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 0.5rem; }
.stat-value { font-size: 2.2rem; font-weight: 800; letter-spacing: -0.04em; line-height: 1; }
.stat-value.ok { color: var(--ok); } .stat-value.warn { color: var(--warn); } .stat-value.danger { color: var(--danger); } .stat-value.neutral { color: var(--text); }

.alert-banner { margin: 1rem 2rem 0; padding: 1rem 1.5rem; border: 1px solid var(--warn); background: rgba(255,179,71,0.08); display: none; align-items: flex-start; gap: 1rem; }
.alert-icon { font-size: 1.2rem; flex-shrink: 0; }
.alert-title { font-weight: 700; font-size: 0.85rem; color: var(--warn); margin-bottom: 0.35rem; }
.alert-list { font-family: 'Space Mono', monospace; font-size: 0.65rem; color: var(--muted); list-style: none; }
.alert-list li { padding: 0.15rem 0; }
.alert-list li::before { content: '‚Äî '; color: var(--warn); }

.main { display: grid; grid-template-columns: 310px 1fr; min-height: calc(100vh - 130px); }
.sidebar { border-right: 1px solid var(--border); padding: 2rem; background: var(--surface); }
.sidebar-title { font-family: 'Space Mono', monospace; font-size: 0.65rem; color: var(--accent); letter-spacing: 0.3em; text-transform: uppercase; margin-bottom: 1.5rem; }

.content-area { padding: 2rem; }
.toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap; }
.search-wrap { flex: 1; min-width: 200px; max-width: 360px; position: relative; }
.search-wrap input { padding-left: 2.5rem; }
.search-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--muted); }
.filter-tabs { display: flex; border: 1px solid var(--border); }
.filter-tab { padding: 0.5rem 1rem; font-family: 'Space Mono', monospace; font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; border: none; background: transparent; color: var(--muted); border-right: 1px solid var(--border); transition: all 0.15s; }
.filter-tab:last-child { border-right: none; }
.filter-tab.active, .filter-tab:hover { background: var(--accent); color: var(--bg); }

.table-wrap { border: 1px solid var(--border); overflow: auto; }
table { width: 100%; border-collapse: collapse; }
thead th { background: var(--surface2); padding: 0.75rem 1rem; text-align: left; font-family: 'Space Mono', monospace; font-size: 0.6rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--muted); border-bottom: 1px solid var(--border); white-space: nowrap; }
tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; animation: fadeIn 0.25s ease; }
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: var(--surface2); }
tbody td { padding: 0.9rem 1rem; font-size: 0.85rem; vertical-align: middle; }

.badge { display: inline-block; padding: 0.25rem 0.6rem; font-family: 'Space Mono', monospace; font-size: 0.6rem; letter-spacing: 0.1em; text-transform: uppercase; font-weight: 700; border: 1px solid; }
.badge-ok { color: var(--ok); border-color: rgba(71,255,143,0.3); background: rgba(71,255,143,0.08); }
.badge-warn { color: var(--warn); border-color: rgba(255,179,71,0.3); background: rgba(255,179,71,0.08); }
.badge-danger { color: var(--danger); border-color: rgba(255,59,59,0.3); background: rgba(255,59,59,0.08); }
.badge-info { color: var(--accent3); border-color: rgba(71,184,255,0.3); background: rgba(71,184,255,0.08); }

.days-left { font-family: 'Space Mono', monospace; font-size: 0.75rem; font-weight: 700; }
.days-left.ok { color: var(--ok); } .days-left.warn { color: var(--warn); } .days-left.danger { color: var(--danger); }
.actions { display: flex; gap: 0.5rem; }
.act-btn { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; font-size: 0.8rem; transition: all 0.15s; }
.act-btn:hover { border-color: var(--accent); color: var(--accent); }
.act-btn.del:hover { border-color: var(--danger); color: var(--danger); }
.empty-state { text-align: center; padding: 4rem 2rem; color: var(--muted); }
.empty-icon { font-size: 3rem; margin-bottom: 1rem; }
.empty-title { font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem; }
.empty-sub { font-family: 'Space Mono', monospace; font-size: 0.7rem; }
.loading { display: inline-flex; align-items: center; gap: 0.5rem; font-family: 'Space Mono', monospace; font-size: 0.7rem; color: var(--muted); }
.spinner { width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 500; display: none; align-items: center; justify-content: center; padding: 1rem; }
.modal-overlay.open { display: flex; }
.modal { background: var(--surface); border: 1px solid var(--border); width: 100%; max-width: 500px; padding: 2rem; position: relative; }
.modal::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--accent3); }
.modal-title { font-size: 1.1rem; font-weight: 800; margin-bottom: 1.5rem; }
.modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
.modal-grid .full { grid-column: 1/-1; }
.modal-actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; justify-content: flex-end; }

@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

@media (max-width: 1100px) { .main { grid-template-columns: 1fr; } .sidebar { border-right: none; border-bottom: 1px solid var(--border); } .stats-bar { grid-template-columns: repeat(2,1fr); } }
@media (max-width: 640px) { .content-area, .sidebar { padding: 1rem; } .header { padding: 1rem; } .stats-bar { grid-template-columns: 1fr 1fr; } }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-card">
    <div class="brand">
      <div class="brand-tag">‚¨° Envanter Sistemi</div>
      <h1>Lisans<span>Takip</span></h1>
      <div class="brand-sub">üî• license-tracker-fb51b ¬∑ Firebase Firestore</div>
    </div>
    <div class="firebase-badge">
      <span>‚úì</span>
      <span>Firebase baƒülantƒ±sƒ± yapƒ±landƒ±rƒ±ldƒ±</span>
    </div>
    <div class="form-group">
      <label>E-Posta</label>
      <input type="email" id="loginEmail" placeholder="admin@sirket.com" autofocus>
    </div>
    <div class="form-group">
      <label>≈ûifre</label>
      <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <button class="btn btn-primary" id="loginBtn"><span id="loginBtnText">Giri≈ü Yap ‚Üí</span></button>
    <div class="error-msg" id="loginError"></div>
  </div>
</div>

<!-- APP -->
<div id="appScreen">
  <div class="header">
    <div class="header-brand">Lisans<span>Takip</span></div>
    <div class="header-right">
      <div class="user-chip" id="userChip">‚Äî</div>
      <button class="btn btn-danger" id="logoutBtn">√áƒ±kƒ±≈ü</button>
    </div>
  </div>

  <div class="stats-bar">
    <div class="stat-item"><div class="stat-label">Toplam Lisans</div><div class="stat-value neutral" id="statTotal">0</div></div>
    <div class="stat-item"><div class="stat-label">‚úì Aktif</div><div class="stat-value ok" id="statActive">0</div></div>
    <div class="stat-item"><div class="stat-label">‚ö† Yakƒ±nda Bitiyor</div><div class="stat-value warn" id="statExpiring">0</div></div>
    <div class="stat-item"><div class="stat-label">‚úï S√ºresi Dolmu≈ü</div><div class="stat-value danger" id="statExpired">0</div></div>
  </div>

  <div class="alert-banner" id="alertBanner">
    <div class="alert-icon">üîî</div>
    <div class="alert-content">
      <div class="alert-title">Dikkat! S√ºresi yakla≈üan veya dolmu≈ü lisanslar:</div>
      <ul class="alert-list" id="alertList"></ul>
    </div>
  </div>

  <div class="main">
    <div class="sidebar">
      <div class="sidebar-title">Ôºã Yeni Lisans Ekle</div>
      <div class="form-group"><label>Yazƒ±lƒ±m / √úr√ºn Adƒ± *</label><input type="text" id="f_name" placeholder="Microsoft Office 365"></div>
      <div class="form-group"><label>Tedarik√ßi</label><input type="text" id="f_vendor" placeholder="Microsoft"></div>
      <div class="form-group">
        <label>Kategori</label>
        <select id="f_category">
          <option value="">‚Äî Se√ßin ‚Äî</option>
          <option>ƒ∞≈ületim Sistemi</option><option>Ofis & Verimlilik</option><option>G√ºvenlik</option>
          <option>Geli≈ütirme Ara√ßlarƒ±</option><option>Tasarƒ±m</option><option>ERP / CRM</option>
          <option>Bulut & Altyapƒ±</option><option>Diƒüer</option>
        </select>
      </div>
      <div class="form-row">
        <div><label>Lisans Sayƒ±sƒ±</label><input type="number" id="f_count" placeholder="1" min="1"></div>
        <div><label>Maliyet (‚Ç∫)</label><input type="number" id="f_cost" placeholder="0"></div>
      </div>
      <div class="form-row">
        <div><label>Ba≈ülangƒ±√ß</label><input type="date" id="f_startDate"></div>
        <div><label>Biti≈ü Tarihi *</label><input type="date" id="f_endDate"></div>
      </div>
      <div class="form-group"><label>Lisans Anahtarƒ±</label><input type="text" id="f_licenseKey" placeholder="XXXXX-XXXXX-XXXXX"></div>
      <div class="form-group"><label>Atanan Ki≈üi / Birim</label><input type="text" id="f_assignee" placeholder="IT Departmanƒ±"></div>
      <div class="form-group"><label>Notlar</label><input type="text" id="f_notes" placeholder="Ek bilgi..."></div>
      <div class="form-group"><label>Uyarƒ± E≈üiƒüi (g√ºn)</label><input type="number" id="f_warnDays" value="30" min="1"></div>
      <button class="btn btn-accent" id="addBtn" style="width:100%;justify-content:center;"><span id="addBtnText">Lisansƒ± Kaydet</span></button>
    </div>

    <div class="content-area">
      <div class="toolbar">
        <div class="search-wrap">
          <span class="search-icon">üîç</span>
          <input type="text" id="searchInput" placeholder="Ara... (isim, tedarik√ßi, kategori)">
        </div>
        <div class="filter-tabs">
          <button class="filter-tab active" data-filter="all">T√ºm√º</button>
          <button class="filter-tab" data-filter="active">Aktif</button>
          <button class="filter-tab" data-filter="expiring">Yakƒ±nda</button>
          <button class="filter-tab" data-filter="expired">Dolmu≈ü</button>
        </div>
        <div id="tableLoading" class="loading" style="display:none;"><div class="spinner"></div> Y√ºkleniyor...</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Yazƒ±lƒ±m</th><th>Tedarik√ßi</th><th>Kategori</th><th>Adet</th><th>Biti≈ü Tarihi</th><th>Kalan G√ºn</th><th>Durum</th><th>Atanan</th><th>ƒ∞≈ülem</th></tr></thead>
          <tbody id="licenseTable"><tr><td colspan="9"><div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-title">Hen√ºz lisans yok</div><div class="empty-sub">Sol panelden yeni lisans ekleyin</div></div></td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">‚úèÔ∏è Lisansƒ± D√ºzenle</div>
    <div class="modal-grid">
      <div class="full"><label>Yazƒ±lƒ±m / √úr√ºn Adƒ±</label><input type="text" id="edit_name"></div>
      <div class="full"><label>Tedarik√ßi</label><input type="text" id="edit_vendor"></div>
      <div><label>Biti≈ü Tarihi</label><input type="date" id="edit_endDate"></div>
      <div><label>Lisans Sayƒ±sƒ±</label><input type="number" id="edit_count"></div>
      <div><label>Maliyet (‚Ç∫)</label><input type="number" id="edit_cost"></div>
      <div><label>Uyarƒ± E≈üiƒüi (g√ºn)</label><input type="number" id="edit_warnDays"></div>
      <div class="full"><label>Atanan Ki≈üi / Birim</label><input type="text" id="edit_assignee"></div>
      <div class="full"><label>Notlar</label><input type="text" id="edit_notes"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="closeModal">ƒ∞ptal</button>
      <button class="btn btn-accent" id="saveEditBtn">Kaydet</button>
    </div>
  </div>
</div>

<script>
let licenses = [], currentFilter = 'all', searchQuery = '', editingId = null, FB = null;

window.addEventListener('firebaseReady', () => {
  FB = window._fb;
  document.getElementById('loginBtn').addEventListener('click', doLogin);
  document.getElementById('loginPass').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
});

async function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;
  const errEl = document.getElementById('loginError');
  const btn = document.getElementById('loginBtn');
  errEl.style.display = 'none';
  if (!email || !pass) { errEl.textContent = 'E-posta ve ≈üifre gerekli.'; errEl.style.display = 'block'; return; }

  document.getElementById('loginBtnText').innerHTML = '<span style="display:flex;align-items:center;gap:0.5rem;"><span class="spinner"></span> Baƒülanƒ±yor...</span>';
  btn.disabled = true;

  try {
    const cred = await FB.signInWithEmailAndPassword(FB.auth, email, pass);
    document.getElementById('userChip').textContent = cred.user.email;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').style.display = 'block';
    await loadLicenses();
  } catch (err) {
    const m = { 'auth/wrong-password':'≈ûifre yanlƒ±≈ü.', 'auth/invalid-credential':'E-posta veya ≈üifre hatalƒ±.', 'auth/user-not-found':'Kullanƒ±cƒ± bulunamadƒ±.', 'auth/invalid-email':'Ge√ßersiz e-posta.', 'auth/too-many-requests':'√áok fazla deneme. Bekleyin.', 'auth/network-request-failed':'Aƒü hatasƒ±.' };
    errEl.textContent = m[err.code] || err.message;
    errEl.style.display = 'block';
  }
  document.getElementById('loginBtnText').textContent = 'Giri≈ü Yap ‚Üí';
  btn.disabled = false;
}

document.getElementById('logoutBtn').addEventListener('click', async () => {
  await FB.signOut(FB.auth);
  licenses = [];
  document.getElementById('appScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  ['loginEmail','loginPass'].forEach(id => document.getElementById(id).value = '');
});

async function loadLicenses() {
  document.getElementById('tableLoading').style.display = 'flex';
  try {
    let snap;
    try { snap = await FB.getDocs(FB.query(FB.collection(FB.db,'licenses'), FB.orderBy('endDate','asc'))); }
    catch { snap = await FB.getDocs(FB.collection(FB.db,'licenses')); }
    licenses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    licenses.sort((a,b) => new Date(a.endDate)-new Date(b.endDate));
    renderTable(); updateStats(); renderAlerts();
  } catch(e) { console.error(e); }
  document.getElementById('tableLoading').style.display = 'none';
}

document.getElementById('addBtn').addEventListener('click', async () => {
  const name = document.getElementById('f_name').value.trim();
  const endDate = document.getElementById('f_endDate').value;
  if (!name||!endDate) { alert('Yazƒ±lƒ±m adƒ± ve biti≈ü tarihi zorunlu!'); return; }
  const data = { name, endDate, vendor: document.getElementById('f_vendor').value.trim(), category: document.getElementById('f_category').value, count: parseInt(document.getElementById('f_count').value)||1, cost: parseFloat(document.getElementById('f_cost').value)||0, startDate: document.getElementById('f_startDate').value, licenseKey: document.getElementById('f_licenseKey').value.trim(), assignee: document.getElementById('f_assignee').value.trim(), notes: document.getElementById('f_notes').value.trim(), warnDays: parseInt(document.getElementById('f_warnDays').value)||30, createdAt: new Date().toISOString() };
  const btn = document.getElementById('addBtn');
  document.getElementById('addBtnText').textContent = 'Kaydediliyor...'; btn.disabled = true;
  try {
    await FB.addDoc(FB.collection(FB.db,'licenses'), data);
    ['f_name','f_vendor','f_licenseKey','f_assignee','f_notes'].forEach(id => document.getElementById(id).value='');
    document.getElementById('f_category').value=''; document.getElementById('f_count').value=''; document.getElementById('f_cost').value=''; document.getElementById('f_startDate').value=''; document.getElementById('f_endDate').value=''; document.getElementById('f_warnDays').value='30';
    await loadLicenses();
  } catch(e) { alert('Kayƒ±t hatasƒ±: '+e.message); }
  document.getElementById('addBtnText').textContent='Lisansƒ± Kaydet'; btn.disabled=false;
});

function getStatus(daysLeft, warnDays) { return daysLeft<0?'expired':daysLeft<=warnDays?'expiring':'active'; }
function formatDate(d) { return d ? new Date(d).toLocaleDateString('tr-TR',{day:'2-digit',month:'2-digit',year:'numeric'}) : '‚Äî'; }
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function renderTable() {
  const tbody = document.getElementById('licenseTable');
  const today = new Date(); today.setHours(0,0,0,0);
  const filtered = licenses.filter(l => {
    const d = Math.ceil((new Date(l.endDate)-today)/86400000);
    const st = getStatus(d,l.warnDays||30);
    if (currentFilter!=='all'&&st!==currentFilter) return false;
    if (searchQuery) { const q=searchQuery.toLowerCase(); return [l.name,l.vendor,l.category,l.assignee].some(x=>(x||'').toLowerCase().includes(q)); }
    return true;
  });
  if (!filtered.length) { tbody.innerHTML=`<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">üîç</div><div class="empty-title">Sonu√ß bulunamadƒ±</div><div class="empty-sub">Filtre veya arama kriterini deƒüi≈ütirin</div></div></td></tr>`; return; }
  tbody.innerHTML = filtered.map(l => {
    const d = Math.ceil((new Date(l.endDate)-today)/86400000);
    const st = getStatus(d,l.warnDays||30);
    const dc = st==='expired'?'danger':st==='expiring'?'warn':'ok';
    const dt = st==='expired'?`${Math.abs(d)}g √∂nce doldu`:`${d}g`;
    const badge = st==='expired'?'<span class="badge badge-danger">Dolmu≈ü</span>':st==='expiring'?'<span class="badge badge-warn">‚ö† Yakƒ±nda</span>':'<span class="badge badge-ok">Aktif</span>';
    return `<tr><td><strong>${esc(l.name)}</strong>${l.licenseKey?`<br><span style="font-family:'Space Mono',monospace;font-size:0.6rem;color:var(--muted)">${esc(l.licenseKey)}</span>`:''}</td><td>${esc(l.vendor||'‚Äî')}</td><td>${l.category?`<span class="badge badge-info">${esc(l.category)}</span>`:'‚Äî'}</td><td style="font-family:'Space Mono',monospace">${l.count||1}</td><td style="font-family:'Space Mono',monospace;font-size:0.8rem">${formatDate(l.endDate)}</td><td><span class="days-left ${dc}">${dt}</span></td><td>${badge}</td><td style="font-size:0.8rem">${esc(l.assignee||'‚Äî')}</td><td><div class="actions"><button class="act-btn" onclick="openEdit('${l.id}')" title="D√ºzenle">‚úèÔ∏è</button><button class="act-btn del" onclick="deleteLicense('${l.id}')" title="Sil">üóëÔ∏è</button></div></td></tr>`;
  }).join('');
}

function updateStats() {
  const today = new Date(); today.setHours(0,0,0,0);
  let a=0,e=0,x=0;
  licenses.forEach(l => { const d=Math.ceil((new Date(l.endDate)-today)/86400000); const st=getStatus(d,l.warnDays||30); if(st==='active')a++;else if(st==='expiring')e++;else x++; });
  document.getElementById('statTotal').textContent=licenses.length; document.getElementById('statActive').textContent=a; document.getElementById('statExpiring').textContent=e; document.getElementById('statExpired').textContent=x;
}

function renderAlerts() {
  const today = new Date(); today.setHours(0,0,0,0);
  const banner=document.getElementById('alertBanner'), list=document.getElementById('alertList');
  const urgent=licenses.filter(l=>{const d=Math.ceil((new Date(l.endDate)-today)/86400000);return getStatus(d,l.warnDays||30)!=='active';}).sort((a,b)=>new Date(a.endDate)-new Date(b.endDate));
  if (urgent.length) { banner.style.display='flex'; list.innerHTML=urgent.map(l=>{const d=Math.ceil((new Date(l.endDate)-today)/86400000);return `<li>${esc(l.name)} ‚Äî ${d<0?Math.abs(d)+' g√ºn √∂nce doldu':d+' g√ºn kaldƒ± ('+formatDate(l.endDate)+')'}</li>`;}).join(''); }
  else banner.style.display='none';
}

async function deleteLicense(id) {
  if (!confirm('Bu lisansƒ± silmek istediƒüinize emin misiniz?')) return;
  try { await FB.deleteDoc(FB.doc(FB.db,'licenses',id)); await loadLicenses(); } catch(e) { alert('Silme hatasƒ±: '+e.message); }
}
window.deleteLicense = deleteLicense;

function openEdit(id) {
  const l=licenses.find(x=>x.id===id); if(!l) return;
  editingId=id;
  ['name','vendor','endDate','count','cost','warnDays','assignee','notes'].forEach(f=>{ document.getElementById('edit_'+f).value=l[f]||''; });
  document.getElementById('edit_count').value=l.count||1; document.getElementById('edit_warnDays').value=l.warnDays||30;
  document.getElementById('editModal').classList.add('open');
}
window.openEdit = openEdit;

document.getElementById('closeModal').addEventListener('click', ()=>document.getElementById('editModal').classList.remove('open'));
document.getElementById('saveEditBtn').addEventListener('click', async ()=>{
  if (!editingId) return;
  const updates={name:document.getElementById('edit_name').value.trim(),vendor:document.getElementById('edit_vendor').value.trim(),endDate:document.getElementById('edit_endDate').value,count:parseInt(document.getElementById('edit_count').value)||1,cost:parseFloat(document.getElementById('edit_cost').value)||0,warnDays:parseInt(document.getElementById('edit_warnDays').value)||30,assignee:document.getElementById('edit_assignee').value.trim(),notes:document.getElementById('edit_notes').value.trim()};
  try { await FB.updateDoc(FB.doc(FB.db,'licenses',editingId),updates); document.getElementById('editModal').classList.remove('open'); await loadLicenses(); } catch(e) { alert('G√ºncelleme hatasƒ±: '+e.message); }
});

document.getElementById('searchInput').addEventListener('input', e=>{ searchQuery=e.target.value; renderTable(); });
document.querySelectorAll('.filter-tab').forEach(btn=>btn.addEventListener('click',()=>{ document.querySelectorAll('.filter-tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); currentFilter=btn.dataset.filter; renderTable(); }));
</script>
</body>
</html>
